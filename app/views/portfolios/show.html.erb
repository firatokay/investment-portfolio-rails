<div class="max-w-6xl mx-auto">
  <!-- Portfolio Header -->
  <div class="bg-white rounded-lg shadow-md p-8 mb-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h1 class="font-bold text-3xl text-gray-900 mb-2"><%= @portfolio.name %></h1>
        <p class="text-gray-600"><%= @portfolio.description.presence || "No description provided" %></p>
      </div>
      <div class="flex space-x-3">
        <%= link_to "Edit", edit_portfolio_path(@portfolio), class: "bg-gray-200 text-gray-700 rounded-md px-4 py-2 hover:bg-gray-300 font-medium" %>
        <%= link_to "Back", portfolios_path, class: "bg-indigo-600 text-white rounded-md px-4 py-2 hover:bg-indigo-700 font-medium" %>
      </div>
    </div>

    <div class="border-t border-gray-200 pt-4 mt-4">
      <p class="text-sm text-gray-500">Created <%= time_ago_in_words(@portfolio.created_at) %> ago</p>
    </div>
  </div>

  <!-- Portfolio Stats -->
  <div class="grid md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 mb-2">Positions</h3>
      <p class="text-3xl font-bold text-indigo-600"><%= @portfolio.positions.count %></p>
      <p class="text-xs text-gray-500 mt-1"><%= @portfolio.positions.count == 0 ? "No positions yet" : "Active positions" %></p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 mb-2">Total Value</h3>
      <p class="text-3xl font-bold text-green-600"><%= number_to_currency(@portfolio.total_value, unit: "#{@portfolio.base_currency} ") %></p>
      <p class="text-xs text-gray-500 mt-1">Portfolio value</p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 mb-2">Assets</h3>
      <p class="text-3xl font-bold text-blue-600"><%= Asset.count %></p>
      <p class="text-xs text-gray-500 mt-1">Available assets</p>
    </div>
  </div>

  <!-- Exchange Rates Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <%
      usd_try_rate = CurrencyRate.where(from_currency: 'USD', to_currency: 'TRY')
                                 .order(date: :desc).first
      eur_try_rate = CurrencyRate.where(from_currency: 'EUR', to_currency: 'TRY')
                                 .order(date: :desc).first
      last_update_time = [usd_try_rate&.updated_at, eur_try_rate&.updated_at].compact.max
    %>
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-900">Exchange Rates</h2>
      <p class="text-xs text-gray-500">
        <%= last_update_time ? "Updated #{time_ago_in_words(last_update_time)} ago" : "No recent data" %>
      </p>
    </div>
    <div class="grid md:grid-cols-2 gap-4">

      <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-lg border border-green-200">
        <div class="flex items-center space-x-3">
          <div class="text-2xl">ðŸ’µ</div>
          <div>
            <p class="text-sm font-medium text-gray-600">USD/TRY</p>
            <p class="text-xs text-gray-500"><%= usd_try_rate&.date&.strftime("%d %b") || "N/A" %></p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-2xl font-bold text-green-700">
            <%= usd_try_rate ? number_with_precision(usd_try_rate.rate, precision: 4) : "N/A" %>
          </p>
          <p class="text-xs text-gray-600">â‚º</p>
        </div>
      </div>

      <div class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200">
        <div class="flex items-center space-x-3">
          <div class="text-2xl">ðŸ’¶</div>
          <div>
            <p class="text-sm font-medium text-gray-600">EUR/TRY</p>
            <p class="text-xs text-gray-500"><%= eur_try_rate&.date&.strftime("%d %b") || "N/A" %></p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-2xl font-bold text-blue-700">
            <%= eur_try_rate ? number_with_precision(eur_try_rate.rate, precision: 4) : "N/A" %>
          </p>
          <p class="text-xs text-gray-600">â‚º</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Positions Section -->
  <div class="bg-white rounded-lg shadow-md p-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold text-gray-900">Positions</h2>
      <%= link_to "Add Position", new_portfolio_position_path(@portfolio), class: "bg-indigo-600 text-white rounded-md px-4 py-2 hover:bg-indigo-700 font-medium" %>
    </div>

    <% if @portfolio.positions.empty? %>
      <div class="text-center py-12">
        <div class="text-6xl mb-4">ðŸ“ˆ</div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No Positions Yet</h3>
        <p class="text-gray-600 mb-4">Start building your portfolio by adding your first position.</p>
        <%= link_to "Add Your First Position", new_portfolio_position_path(@portfolio), class: "inline-block bg-indigo-600 text-white rounded-md px-6 py-3 hover:bg-indigo-700 font-semibold" %>
      </div>
    <% else %>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Cost</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Current Price</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">P&L</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @portfolio.positions.includes(:asset).each do |position| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900"><%= position.asset.symbol %></div>
                  <div class="text-sm text-gray-500"><%= position.asset.name %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                    <%= position.asset.asset_class_display %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  <%= number_with_precision(position.quantity, precision: 4, strip_insignificant_zeros: true) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  <%= number_to_currency(position.average_cost, unit: "#{position.purchase_currency} ") %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  <% if position.asset.latest_price %>
                    <%= number_to_currency(position.asset.latest_price, unit: "#{position.asset.currency} ") %>
                  <% else %>
                    <span class="text-gray-400">N/A</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                  <%= number_to_currency(position.current_value, unit: "#{@portfolio.base_currency} ") %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <% pl = position.profit_loss %>
                  <% pl_pct = position.profit_loss_percentage %>
                  <span class="<%= pl >= 0 ? 'text-green-600' : 'text-red-600' %>">
                    <%= pl >= 0 ? '+' : '' %><%= number_to_currency(pl, unit: "") %><br>
                    <span class="text-xs">(<%= pl_pct >= 0 ? '+' : '' %><%= pl_pct %>%)</span>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                  <%= link_to "Progress", progress_portfolio_position_path(@portfolio, position), data: { turbo_frame: "progress_modal" }, class: "text-green-600 hover:text-green-900 mr-3" %>
                  <%= link_to "Edit", edit_portfolio_position_path(@portfolio, position), class: "text-indigo-600 hover:text-indigo-900 mr-3" %>
                  <%= button_to "Delete", portfolio_position_path(@portfolio, position), method: :delete, data: { confirm: "Are you sure?", turbo_confirm: "Are you sure?" }, class: "text-red-600 hover:text-red-900 inline" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
</div>

<!-- Modal Container for Progress Chart -->
<%= turbo_frame_tag "progress_modal" %>
