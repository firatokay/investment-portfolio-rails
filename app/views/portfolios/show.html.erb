<div class="max-w-6xl mx-auto">
  <!-- Portfolio Header -->
  <div class="bg-white rounded-lg shadow-md p-8 mb-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h1 class="font-bold text-3xl text-gray-900 mb-2"><%= @portfolio.name %></h1>
        <p class="text-gray-600"><%= @portfolio.description.presence || "No description provided" %></p>
      </div>
      <div class="flex space-x-3">
        <%= link_to "Edit", edit_portfolio_path(@portfolio), class: "bg-gray-200 text-gray-700 rounded-md px-4 py-2 hover:bg-gray-300 font-medium" %>
        <%= link_to "Back", portfolios_path, class: "bg-indigo-600 text-white rounded-md px-4 py-2 hover:bg-indigo-700 font-medium" %>
      </div>
    </div>

    <div class="border-t border-gray-200 pt-4 mt-4">
      <p class="text-sm text-gray-500">Created <%= time_ago_in_words(@portfolio.created_at) %> ago</p>
    </div>
  </div>

  <!-- Portfolio Stats -->
  <div class="grid md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 mb-2">Positions</h3>
      <p class="text-3xl font-bold text-indigo-600"><%= @portfolio.positions.count %></p>
      <p class="text-xs text-gray-500 mt-1"><%= @portfolio.positions.count == 0 ? "No positions yet" : "Active positions" %></p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 mb-2">Total Value</h3>
      <p class="text-3xl font-bold text-green-600"><%= number_to_currency(@portfolio.total_value, unit: "#{@portfolio.base_currency} ") %></p>
      <p class="text-xs text-gray-500 mt-1">Portfolio value</p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 mb-2">Assets</h3>
      <p class="text-3xl font-bold text-blue-600"><%= Asset.count %></p>
      <p class="text-xs text-gray-500 mt-1">Available assets</p>
    </div>
  </div>

  <!-- Exchange Rates Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <%
      usd_try_rate = CurrencyRate.where(from_currency: 'USD', to_currency: 'TRY')
                                 .order(date: :desc).first
      eur_try_rate = CurrencyRate.where(from_currency: 'EUR', to_currency: 'TRY')
                                 .order(date: :desc).first
      last_update_time = [usd_try_rate&.updated_at, eur_try_rate&.updated_at].compact.max
    %>
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-900">Exchange Rates</h2>
      <p class="text-xs text-gray-500">
        <%= last_update_time ? "Updated #{time_ago_in_words(last_update_time)} ago" : "No recent data" %>
      </p>
    </div>
    <div class="grid md:grid-cols-2 gap-4">

      <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-lg border border-green-200">
        <div class="flex items-center space-x-3">
          <div class="text-2xl">ðŸ’µ</div>
          <div>
            <p class="text-sm font-medium text-gray-600">USD/TRY</p>
            <p class="text-xs text-gray-500"><%= usd_try_rate&.date&.strftime("%d %b") || "N/A" %></p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-2xl font-bold text-green-700">
            <%= usd_try_rate ? number_with_precision(usd_try_rate.rate, precision: 4) : "N/A" %>
          </p>
          <p class="text-xs text-gray-600">â‚º</p>
        </div>
      </div>

      <div class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200">
        <div class="flex items-center space-x-3">
          <div class="text-2xl">ðŸ’¶</div>
          <div>
            <p class="text-sm font-medium text-gray-600">EUR/TRY</p>
            <p class="text-xs text-gray-500"><%= eur_try_rate&.date&.strftime("%d %b") || "N/A" %></p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-2xl font-bold text-blue-700">
            <%= eur_try_rate ? number_with_precision(eur_try_rate.rate, precision: 4) : "N/A" %>
          </p>
          <p class="text-xs text-gray-600">â‚º</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Positions Section -->
  <div class="bg-white rounded-lg shadow-md p-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold text-gray-900">Positions</h2>
      <div class="flex space-x-3">
        <% if @portfolio.positions.any? %>
          <button id="ai-advisor-btn" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-md px-4 py-2 hover:from-purple-700 hover:to-indigo-700 font-medium flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <span>AI Advisor</span>
          </button>
        <% end %>
        <%= link_to "Add Position", new_portfolio_position_path(@portfolio), class: "bg-indigo-600 text-white rounded-md px-4 py-2 hover:bg-indigo-700 font-medium" %>
      </div>
    </div>

    <% if @portfolio.positions.empty? %>
      <div class="text-center py-12">
        <div class="text-6xl mb-4">ðŸ“ˆ</div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No Positions Yet</h3>
        <p class="text-gray-600 mb-4">Start building your portfolio by adding your first position.</p>
        <%= link_to "Add Your First Position", new_portfolio_position_path(@portfolio), class: "inline-block bg-indigo-600 text-white rounded-md px-6 py-3 hover:bg-indigo-700 font-semibold" %>
      </div>
    <% else %>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Cost</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Current Price</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">P&L</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @portfolio.positions.includes(:asset).each do |position| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900"><%= position.asset.symbol %></div>
                  <div class="text-sm text-gray-500"><%= position.asset.name %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                    <%= position.asset.asset_class_display %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  <%= number_with_precision(position.quantity, precision: 4, strip_insignificant_zeros: true) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  <%= number_to_currency(position.average_cost, unit: "#{position.purchase_currency} ") %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  <% if position.asset.latest_price %>
                    <%= number_to_currency(position.asset.latest_price, unit: "#{position.asset.currency} ") %>
                  <% else %>
                    <span class="text-gray-400">N/A</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                  <%= number_to_currency(position.current_value, unit: "#{@portfolio.base_currency} ") %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <% pl = position.profit_loss %>
                  <% pl_pct = position.profit_loss_percentage %>
                  <span class="<%= pl >= 0 ? 'text-green-600' : 'text-red-600' %>">
                    <%= pl >= 0 ? '+' : '' %><%= number_to_currency(pl, unit: "") %><br>
                    <span class="text-xs">(<%= pl_pct >= 0 ? '+' : '' %><%= pl_pct %>%)</span>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                  <%= link_to "Progress", progress_portfolio_position_path(@portfolio, position), data: { turbo_frame: "progress_modal" }, class: "text-green-600 hover:text-green-900 mr-3" %>
                  <%= link_to "Edit", edit_portfolio_position_path(@portfolio, position), class: "text-indigo-600 hover:text-indigo-900 mr-3" %>
                  <%= button_to "Delete", portfolio_position_path(@portfolio, position), method: :delete, data: { confirm: "Are you sure?", turbo_confirm: "Are you sure?" }, class: "text-red-600 hover:text-red-900 inline" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
</div>

<!-- Modal Container for Progress Chart -->
<%= turbo_frame_tag "progress_modal" do %>
  <!-- Loading state for Turbo Frame -->
  <div class="hidden" id="turbo-loading">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-40"></div>
    <div class="fixed inset-0 z-50 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative transform overflow-hidden rounded-lg bg-white shadow-xl transition-all w-full max-w-md p-8">
          <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Loading Position Progress</h3>
            <p class="text-gray-600">Calculating analytics and rendering chart...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
// Show loading indicator when Turbo Frame starts loading
document.addEventListener('turbo:frame-load', function(event) {
  if (event.target.id === 'progress_modal') {
    const loadingDiv = document.getElementById('turbo-loading');
    if (loadingDiv) {
      loadingDiv.classList.remove('hidden');
    }
  }
});

// Hide loading indicator when Turbo Frame finishes loading
document.addEventListener('turbo:frame-render', function(event) {
  if (event.target.id === 'progress_modal') {
    const loadingDiv = document.getElementById('turbo-loading');
    if (loadingDiv) {
      loadingDiv.classList.add('hidden');
    }
  }
});
</script>

<!-- AI Advisor Modal -->
<div id="ai-advisor-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-2xl font-bold text-gray-900 flex items-center space-x-2">
        <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
        </svg>
        <span>AI Portfolio Advisor</span>
      </h3>
      <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">
        &times;
      </button>
    </div>

    <div id="ai-advisor-loading" class="text-center py-12">
      <div class="relative inline-flex mb-6">
        <svg class="animate-spin h-16 w-16 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <svg class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 h-8 w-8 text-purple-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
        </svg>
      </div>
      <h4 class="text-gray-900 text-xl font-semibold mb-2">Analyzing Your Portfolio</h4>
      <p class="text-gray-600 text-base mb-4">Our AI is reviewing your positions, performance, and market trends</p>
      <div class="max-w-md mx-auto">
        <div class="bg-gray-200 rounded-full h-2 mb-3 overflow-hidden">
          <div class="bg-gradient-to-r from-purple-600 to-indigo-600 h-2 rounded-full animate-progress"></div>
        </div>
        <p class="text-gray-500 text-sm">This typically takes 5-10 seconds</p>
      </div>
    </div>

    <style>
      @keyframes progress {
        0% { width: 0%; }
        50% { width: 70%; }
        100% { width: 90%; }
      }
      .animate-progress {
        animation: progress 8s ease-in-out infinite;
      }
    </style>

    <div id="ai-advisor-content" class="hidden">
      <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4 mb-4">
        <p class="text-sm text-gray-700">
          <strong>Note:</strong> This analysis is generated by AI and should be used for informational purposes only.
          Always consult with a qualified financial advisor before making investment decisions.
        </p>
      </div>
      <div id="ai-advisor-analysis" class="prose max-w-none">
        <!-- AI analysis will be inserted here -->
      </div>
      <div class="text-xs text-gray-500 mt-4 pt-4 border-t border-gray-200">
        <p id="ai-advisor-timestamp"></p>
      </div>
    </div>

    <div id="ai-advisor-error" class="hidden">
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <p class="text-red-800 font-medium">Failed to generate recommendations</p>
        <p class="text-red-600 text-sm mt-2" id="ai-advisor-error-message"></p>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const modal = document.getElementById('ai-advisor-modal');
  const btn = document.getElementById('ai-advisor-btn');
  const closeBtn = document.getElementById('close-modal');
  const loadingDiv = document.getElementById('ai-advisor-loading');
  const contentDiv = document.getElementById('ai-advisor-content');
  const errorDiv = document.getElementById('ai-advisor-error');
  const analysisDiv = document.getElementById('ai-advisor-analysis');
  const timestampDiv = document.getElementById('ai-advisor-timestamp');
  const errorMessageDiv = document.getElementById('ai-advisor-error-message');

  // Track loading state to prevent double-submission
  let isLoading = false;

  if (btn) {
    btn.addEventListener('click', async function() {
      // Prevent double-submission
      if (isLoading) {
        return;
      }

      // Set loading state
      isLoading = true;
      btn.disabled = true;
      btn.classList.add('opacity-50', 'cursor-not-allowed');

      // Show original button text with loading indicator
      const originalButtonHtml = btn.innerHTML;
      btn.innerHTML = `
        <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Analyzing...</span>
      `;

      // Show modal
      modal.classList.remove('hidden');

      // Reset to loading state
      loadingDiv.classList.remove('hidden');
      contentDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');

      try {
        const response = await fetch('<%= ai_advisor_portfolio_path(@portfolio) %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          }
        });

        const data = await response.json();

        if (data.success) {
          // Hide loading, show content
          loadingDiv.classList.add('hidden');
          contentDiv.classList.remove('hidden');

          // Format the analysis text with proper HTML
          const formattedAnalysis = formatAnalysis(data.analysis);
          analysisDiv.innerHTML = formattedAnalysis;

          // Set timestamp
          const date = new Date(data.generated_at);
          timestampDiv.textContent = 'Generated on ' + date.toLocaleString();
        } else {
          // Show error
          loadingDiv.classList.add('hidden');
          errorDiv.classList.remove('hidden');
          errorMessageDiv.textContent = data.error || 'An unknown error occurred';
        }
      } catch (error) {
        // Show error
        loadingDiv.classList.add('hidden');
        errorDiv.classList.remove('hidden');
        errorMessageDiv.textContent = 'Network error: ' + error.message;
      } finally {
        // Reset button state
        isLoading = false;
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.innerHTML = originalButtonHtml;
      }
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      modal.classList.add('hidden');
    });
  }

  // Close modal when clicking outside
  window.addEventListener('click', function(event) {
    if (event.target === modal) {
      modal.classList.add('hidden');
    }
  });

  // Prevent closing modal while loading (optional safety feature)
  modal.addEventListener('click', function(event) {
    if (event.target === modal && isLoading) {
      event.stopPropagation();
    }
  });

  function formatAnalysis(text) {
    // Convert markdown-style headers and formatting to HTML
    let html = text
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^### (.+)$/gm, '<h3 class="text-xl font-bold text-gray-900 mt-6 mb-3">$1</h3>')
      .replace(/^## (.+)$/gm, '<h2 class="text-2xl font-bold text-gray-900 mt-8 mb-4">$1</h2>')
      .replace(/^# (.+)$/gm, '<h1 class="text-3xl font-bold text-gray-900 mt-10 mb-5">$1</h1>')
      .replace(/^\d+\.\s+(.+)$/gm, '<li class="ml-6 mb-2">$1</li>')
      .replace(/^- (.+)$/gm, '<li class="ml-6 mb-2">$1</li>')
      .replace(/\n\n/g, '</p><p class="mb-4">');

    // Wrap in paragraph tags
    html = '<p class="mb-4">' + html + '</p>';

    // Wrap lists in ul tags
    html = html.replace(/(<li class="ml-6 mb-2">.+?<\/li>)/gs, function(match) {
      return '<ul class="list-disc mb-4">' + match + '</ul>';
    });

    return html;
  }
})();
</script>
