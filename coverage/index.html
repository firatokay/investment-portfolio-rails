<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Investment-portfolio-rails</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.2/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.2/favicon_yellow.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.13.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2025-11-24T18:56:24+03:00">2025-11-24T18:56:24+03:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="yellow">
  86.62%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         23.21
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>34</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>1061</b> relevant lines,
    <span class="green"><b>919</b> lines covered</span> and
    <span class="red"><b>142</b> lines missed. </span>
    (<span class="yellow">
  86.62%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4f74135aba1510358d4a79cbd86192c30ff528c5" class="src_link" title="app/controllers/analytics_controller.rb">app/controllers/analytics_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">58</td>
            <td class="cell--number">29</td>
            <td class="cell--number">29</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2.69</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a57d1d63f7fc5712b9617f8213a3a7ec85fae928" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">71.43 %</td>
            <td class="cell--number">14</td>
            <td class="cell--number">7</td>
            <td class="cell--number">5</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.71</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5e7da4fd8c010e14061d52fb16a6b327f60a3292" class="src_link" title="app/controllers/home_controller.rb">app/controllers/home_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">7</td>
            <td class="cell--number">0</td>
            <td class="cell--number">7</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#92d3b46c6bc72f09b2610c2c4b94a9e42d96fd89" class="src_link" title="app/controllers/portfolios_controller.rb">app/controllers/portfolios_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">111</td>
            <td class="cell--number">46</td>
            <td class="cell--number">46</td>
            <td class="cell--number">0</td>
            <td class="cell--number">6.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cef55fd7d1ae1de7512eb7d76eb279067a548d7d" class="src_link" title="app/controllers/positions_controller.rb">app/controllers/positions_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">94.87 %</td>
            <td class="cell--number">202</td>
            <td class="cell--number">78</td>
            <td class="cell--number">74</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4.03</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a9957d6673b1bf7e2d5f707091a5574175c36944" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#dfdb5f16330e3a905e796ffa16f4e09bcba61ce6" class="src_link" title="app/helpers/home_helper.rb">app/helpers/home_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d31566f0cb11380775b3bec3233df9f30abe6555" class="src_link" title="app/helpers/portfolios_helper.rb">app/helpers/portfolios_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#99abfa6f5af7e9de28e958d658a37ff5ead52692" class="src_link" title="app/helpers/positions_helper.rb">app/helpers/positions_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a08053d2e1a3efe7b771758d0c6ae1ae1775e240" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e4f5c53ba44ce997e29bd38a5d928bae28bc5193" class="src_link" title="app/jobs/fetch_commodity_prices_job.rb">app/jobs/fetch_commodity_prices_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.86</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ff43b390fcaa70fff7700c41d8fc29dbec13197b" class="src_link" title="app/jobs/fetch_cryptocurrency_prices_job.rb">app/jobs/fetch_cryptocurrency_prices_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.86</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2ac042e83360d3851cbbab5a2a75c1749770369d" class="src_link" title="app/jobs/fetch_forex_rates_job.rb">app/jobs/fetch_forex_rates_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.86</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5c5417d64fc54559f4ec24304163a1046394b4ad" class="src_link" title="app/jobs/fetch_stock_prices_job.rb">app/jobs/fetch_stock_prices_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.29</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e6c98df4e18aff2379d3bf6ebf5840f6bc214575" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#966f3aafb8afd6a52ed82c40e630fddb65153f50" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#706cb74519658fc9f53c3ade03ca2a2ab5b73c33" class="src_link" title="app/models/asset.rb">app/models/asset.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.67 %</td>
            <td class="cell--number">75</td>
            <td class="cell--number">30</td>
            <td class="cell--number">29</td>
            <td class="cell--number">1</td>
            <td class="cell--number">33.43</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c94e338b1a7a3df2a925c0d68d4bf20cfe21a071" class="src_link" title="app/models/asset_metadata.rb">app/models/asset_metadata.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">10</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6b44db94f6d1256ee3080d71f88821be6bfe9080" class="src_link" title="app/models/currency_rate.rb">app/models/currency_rate.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">24</td>
            <td class="cell--number">12</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.67</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e5dd615a25177a491d375173b74f470020ac07b7" class="src_link" title="app/models/portfolio.rb">app/models/portfolio.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">24</td>
            <td class="cell--number">12</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0</td>
            <td class="cell--number">117.17</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#fa4b1270baef3184b9df86efb6ffba99bedf0679" class="src_link" title="app/models/position.rb">app/models/position.rb</a></td>
            <td class="red strong cell--number t-file__coverage">79.66 %</td>
            <td class="cell--number">146</td>
            <td class="cell--number">59</td>
            <td class="cell--number">47</td>
            <td class="cell--number">12</td>
            <td class="cell--number">66.95</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4707c18aa4ecfa7eb5047cdde2f2a47bdf9d76a5" class="src_link" title="app/models/price_history.rb">app/models/price_history.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.33</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ac3c20a9d0a2999de09e17e5b23d3c41f76ec425" class="src_link" title="app/models/transaction.rb">app/models/transaction.rb</a></td>
            <td class="red strong cell--number t-file__coverage">40.91 %</td>
            <td class="cell--number">44</td>
            <td class="cell--number">22</td>
            <td class="cell--number">9</td>
            <td class="cell--number">13</td>
            <td class="cell--number">0.41</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3c65de0677001c47e985d0ee0979ae160f39cd6c" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">17</td>
            <td class="cell--number">6</td>
            <td class="cell--number">6</td>
            <td class="cell--number">0</td>
            <td class="cell--number">7.83</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3383c7e460238085765a5f9ed375ef1e53543704" class="src_link" title="app/services/ai/portfolio_advisor.rb">app/services/ai/portfolio_advisor.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">191</td>
            <td class="cell--number">57</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">17.18</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#74d7c4e0a53282412c52b5fac62398eb0109fe23" class="src_link" title="app/services/currency_converter_service.rb">app/services/currency_converter_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">91.67 %</td>
            <td class="cell--number">151</td>
            <td class="cell--number">48</td>
            <td class="cell--number">44</td>
            <td class="cell--number">4</td>
            <td class="cell--number">186.81</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c76d34a6223f30fe80e50555ab64d782d94f8407" class="src_link" title="app/services/market_data/commodity_data_service.rb">app/services/market_data/commodity_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">94.29 %</td>
            <td class="cell--number">182</td>
            <td class="cell--number">70</td>
            <td class="cell--number">66</td>
            <td class="cell--number">4</td>
            <td class="cell--number">9.07</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c11c0c1a568350358d41fb69a8e615f3568f5545" class="src_link" title="app/services/market_data/cryptocurrency_data_service.rb">app/services/market_data/cryptocurrency_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">95.59 %</td>
            <td class="cell--number">176</td>
            <td class="cell--number">68</td>
            <td class="cell--number">65</td>
            <td class="cell--number">3</td>
            <td class="cell--number">13.09</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#73dd444c1dde7e7a2a64a40ba541947120f6c901" class="src_link" title="app/services/market_data/forex_data_service.rb">app/services/market_data/forex_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.53 %</td>
            <td class="cell--number">189</td>
            <td class="cell--number">68</td>
            <td class="cell--number">67</td>
            <td class="cell--number">1</td>
            <td class="cell--number">18.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#da851b6f70becc5538165251003d3c5f01b1f5e6" class="src_link" title="app/services/market_data/historical_price_fetcher.rb">app/services/market_data/historical_price_fetcher.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">90.00 %</td>
            <td class="cell--number">211</td>
            <td class="cell--number">90</td>
            <td class="cell--number">81</td>
            <td class="cell--number">9</td>
            <td class="cell--number">4.44</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b504616f36c884517c3f02e38639b7ad15781aac" class="src_link" title="app/services/market_data/stock_data_service.rb">app/services/market_data/stock_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.43 %</td>
            <td class="cell--number">146</td>
            <td class="cell--number">56</td>
            <td class="cell--number">54</td>
            <td class="cell--number">2</td>
            <td class="cell--number">13.16</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4e6e425e5a93e2295638e73e4498090439430bca" class="src_link" title="app/services/market_data/twelve_data_provider.rb">app/services/market_data/twelve_data_provider.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.08 %</td>
            <td class="cell--number">140</td>
            <td class="cell--number">52</td>
            <td class="cell--number">51</td>
            <td class="cell--number">1</td>
            <td class="cell--number">31.21</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#48bde42efec994e1fcf027978bdcc7b5bf4dc90d" class="src_link" title="app/services/portfolio_analytics_service.rb">app/services/portfolio_analytics_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.83 %</td>
            <td class="cell--number">243</td>
            <td class="cell--number">92</td>
            <td class="cell--number">90</td>
            <td class="cell--number">2</td>
            <td class="cell--number">19.29</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#565d69b092e23f60632bcf4e8d5a7aae71253edf" class="src_link" title="app/workers/market_data_update_worker.rb">app/workers/market_data_update_worker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">90</td>
            <td class="cell--number">73</td>
            <td class="cell--number">0</td>
            <td class="cell--number">73</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent">
      <span class="green">
  92.22%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         4.03
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Controllers"></a>

  <div>
    <b>5</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>167</b> relevant lines,
    <span class="green"><b>154</b> lines covered</span> and
    <span class="red"><b>13</b> lines missed. </span>
    (<span class="green">
  92.22%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4f74135aba1510358d4a79cbd86192c30ff528c5" class="src_link" title="app/controllers/analytics_controller.rb">app/controllers/analytics_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">58</td>
            <td class="cell--number">29</td>
            <td class="cell--number">29</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2.69</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a57d1d63f7fc5712b9617f8213a3a7ec85fae928" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">71.43 %</td>
            <td class="cell--number">14</td>
            <td class="cell--number">7</td>
            <td class="cell--number">5</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.71</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5e7da4fd8c010e14061d52fb16a6b327f60a3292" class="src_link" title="app/controllers/home_controller.rb">app/controllers/home_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">7</td>
            <td class="cell--number">0</td>
            <td class="cell--number">7</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#92d3b46c6bc72f09b2610c2c4b94a9e42d96fd89" class="src_link" title="app/controllers/portfolios_controller.rb">app/controllers/portfolios_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">111</td>
            <td class="cell--number">46</td>
            <td class="cell--number">46</td>
            <td class="cell--number">0</td>
            <td class="cell--number">6.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cef55fd7d1ae1de7512eb7d76eb279067a548d7d" class="src_link" title="app/controllers/positions_controller.rb">app/controllers/positions_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">94.87 %</td>
            <td class="cell--number">202</td>
            <td class="cell--number">78</td>
            <td class="cell--number">74</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4.03</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Channels">
  <h2>
    <span class="group_name">Channels</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Channels"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent">
      <span class="yellow">
  83.23%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         41.63
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Models"></a>

  <div>
    <b>9</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>155</b> relevant lines,
    <span class="green"><b>129</b> lines covered</span> and
    <span class="red"><b>26</b> lines missed. </span>
    (<span class="yellow">
  83.23%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#966f3aafb8afd6a52ed82c40e630fddb65153f50" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#706cb74519658fc9f53c3ade03ca2a2ab5b73c33" class="src_link" title="app/models/asset.rb">app/models/asset.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.67 %</td>
            <td class="cell--number">75</td>
            <td class="cell--number">30</td>
            <td class="cell--number">29</td>
            <td class="cell--number">1</td>
            <td class="cell--number">33.43</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c94e338b1a7a3df2a925c0d68d4bf20cfe21a071" class="src_link" title="app/models/asset_metadata.rb">app/models/asset_metadata.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">10</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6b44db94f6d1256ee3080d71f88821be6bfe9080" class="src_link" title="app/models/currency_rate.rb">app/models/currency_rate.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">24</td>
            <td class="cell--number">12</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.67</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e5dd615a25177a491d375173b74f470020ac07b7" class="src_link" title="app/models/portfolio.rb">app/models/portfolio.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">24</td>
            <td class="cell--number">12</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0</td>
            <td class="cell--number">117.17</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#fa4b1270baef3184b9df86efb6ffba99bedf0679" class="src_link" title="app/models/position.rb">app/models/position.rb</a></td>
            <td class="red strong cell--number t-file__coverage">79.66 %</td>
            <td class="cell--number">146</td>
            <td class="cell--number">59</td>
            <td class="cell--number">47</td>
            <td class="cell--number">12</td>
            <td class="cell--number">66.95</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4707c18aa4ecfa7eb5047cdde2f2a47bdf9d76a5" class="src_link" title="app/models/price_history.rb">app/models/price_history.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.33</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ac3c20a9d0a2999de09e17e5b23d3c41f76ec425" class="src_link" title="app/models/transaction.rb">app/models/transaction.rb</a></td>
            <td class="red strong cell--number t-file__coverage">40.91 %</td>
            <td class="cell--number">44</td>
            <td class="cell--number">22</td>
            <td class="cell--number">9</td>
            <td class="cell--number">13</td>
            <td class="cell--number">0.41</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3c65de0677001c47e985d0ee0979ae160f39cd6c" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">17</td>
            <td class="cell--number">6</td>
            <td class="cell--number">6</td>
            <td class="cell--number">0</td>
            <td class="cell--number">7.83</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Mailers"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>4</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>4</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e6c98df4e18aff2379d3bf6ebf5840f6bc214575" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="yellow">
         1.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Helpers"></a>

  <div>
    <b>4</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>4</b> relevant lines,
    <span class="green"><b>4</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a9957d6673b1bf7e2d5f707091a5574175c36944" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#dfdb5f16330e3a905e796ffa16f4e09bcba61ce6" class="src_link" title="app/helpers/home_helper.rb">app/helpers/home_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d31566f0cb11380775b3bec3233df9f30abe6555" class="src_link" title="app/helpers/portfolios_helper.rb">app/helpers/portfolios_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#99abfa6f5af7e9de28e958d658a37ff5ead52692" class="src_link" title="app/helpers/positions_helper.rb">app/helpers/positions_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent">
      <span class="red">
  43.85%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.72
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Jobs"></a>

  <div>
    <b>6</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>130</b> relevant lines,
    <span class="green"><b>57</b> lines covered</span> and
    <span class="red"><b>73</b> lines missed. </span>
    (<span class="red">
  43.85%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a08053d2e1a3efe7b771758d0c6ae1ae1775e240" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e4f5c53ba44ce997e29bd38a5d928bae28bc5193" class="src_link" title="app/jobs/fetch_commodity_prices_job.rb">app/jobs/fetch_commodity_prices_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.86</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ff43b390fcaa70fff7700c41d8fc29dbec13197b" class="src_link" title="app/jobs/fetch_cryptocurrency_prices_job.rb">app/jobs/fetch_cryptocurrency_prices_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.86</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2ac042e83360d3851cbbab5a2a75c1749770369d" class="src_link" title="app/jobs/fetch_forex_rates_job.rb">app/jobs/fetch_forex_rates_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.86</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5c5417d64fc54559f4ec24304163a1046394b4ad" class="src_link" title="app/jobs/fetch_stock_prices_job.rb">app/jobs/fetch_stock_prices_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.29</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#565d69b092e23f60632bcf4e8d5a7aae71253edf" class="src_link" title="app/workers/market_data_update_worker.rb">app/workers/market_data_update_worker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">90</td>
            <td class="cell--number">73</td>
            <td class="cell--number">0</td>
            <td class="cell--number">73</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Libraries"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent">
      <span class="green">
  95.67%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         28.74
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Ungrouped"></a>

  <div>
    <b>9</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>601</b> relevant lines,
    <span class="green"><b>575</b> lines covered</span> and
    <span class="red"><b>26</b> lines missed. </span>
    (<span class="green">
  95.67%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3383c7e460238085765a5f9ed375ef1e53543704" class="src_link" title="app/services/ai/portfolio_advisor.rb">app/services/ai/portfolio_advisor.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">191</td>
            <td class="cell--number">57</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">17.18</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#74d7c4e0a53282412c52b5fac62398eb0109fe23" class="src_link" title="app/services/currency_converter_service.rb">app/services/currency_converter_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">91.67 %</td>
            <td class="cell--number">151</td>
            <td class="cell--number">48</td>
            <td class="cell--number">44</td>
            <td class="cell--number">4</td>
            <td class="cell--number">186.81</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c76d34a6223f30fe80e50555ab64d782d94f8407" class="src_link" title="app/services/market_data/commodity_data_service.rb">app/services/market_data/commodity_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">94.29 %</td>
            <td class="cell--number">182</td>
            <td class="cell--number">70</td>
            <td class="cell--number">66</td>
            <td class="cell--number">4</td>
            <td class="cell--number">9.07</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c11c0c1a568350358d41fb69a8e615f3568f5545" class="src_link" title="app/services/market_data/cryptocurrency_data_service.rb">app/services/market_data/cryptocurrency_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">95.59 %</td>
            <td class="cell--number">176</td>
            <td class="cell--number">68</td>
            <td class="cell--number">65</td>
            <td class="cell--number">3</td>
            <td class="cell--number">13.09</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#73dd444c1dde7e7a2a64a40ba541947120f6c901" class="src_link" title="app/services/market_data/forex_data_service.rb">app/services/market_data/forex_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.53 %</td>
            <td class="cell--number">189</td>
            <td class="cell--number">68</td>
            <td class="cell--number">67</td>
            <td class="cell--number">1</td>
            <td class="cell--number">18.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#da851b6f70becc5538165251003d3c5f01b1f5e6" class="src_link" title="app/services/market_data/historical_price_fetcher.rb">app/services/market_data/historical_price_fetcher.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">90.00 %</td>
            <td class="cell--number">211</td>
            <td class="cell--number">90</td>
            <td class="cell--number">81</td>
            <td class="cell--number">9</td>
            <td class="cell--number">4.44</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b504616f36c884517c3f02e38639b7ad15781aac" class="src_link" title="app/services/market_data/stock_data_service.rb">app/services/market_data/stock_data_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.43 %</td>
            <td class="cell--number">146</td>
            <td class="cell--number">56</td>
            <td class="cell--number">54</td>
            <td class="cell--number">2</td>
            <td class="cell--number">13.16</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4e6e425e5a93e2295638e73e4498090439430bca" class="src_link" title="app/services/market_data/twelve_data_provider.rb">app/services/market_data/twelve_data_provider.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.08 %</td>
            <td class="cell--number">140</td>
            <td class="cell--number">52</td>
            <td class="cell--number">51</td>
            <td class="cell--number">1</td>
            <td class="cell--number">31.21</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#48bde42efec994e1fcf027978bdcc7b5bf4dc90d" class="src_link" title="app/services/portfolio_analytics_service.rb">app/services/portfolio_analytics_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.83 %</td>
            <td class="cell--number">243</td>
            <td class="cell--number">92</td>
            <td class="cell--number">90</td>
            <td class="cell--number">2</td>
            <td class="cell--number">19.29</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.22.0
        and simplecov-html v0.13.2<br/>
        using RSpec
      </div>

      <div class="source_files">
      
        <div class="source_table" id="4f74135aba1510358d4a79cbd86192c30ff528c5">
  <div class="header">
    <h3>app/controllers/analytics_controller.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>29</b> relevant lines.
      <span class="green"><b>29</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AnalyticsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authenticate_user!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :set_portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authorize_user!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # GET /portfolios/:portfolio_id/analytics</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    @analytics = @portfolio.analytics.analytics_summary</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    respond_to do |format|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      format.html</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="11">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      format.json { render json: @analytics }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  # GET /portfolios/:portfolio_id/analytics/timeline</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def timeline</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="17">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    days = params[:days]&amp;.to_i || 30</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="18">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @timeline = @portfolio.analytics.value_timeline(days: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="20">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    respond_to do |format|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="21">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      format.json { render json: @timeline }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  # GET /portfolios/:portfolio_id/analytics/allocation</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def allocation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    allocation_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="28">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      by_asset_class: @portfolio.analytics.asset_allocation_by_class,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      by_currency: @portfolio.analytics.asset_allocation_by_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="32">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    respond_to do |format|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="33">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      format.json { render json: allocation_data }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  # GET /portfolios/:portfolio_id/analytics/performance</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def performance</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="39">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    period = params[:period]&amp;.to_sym || :month</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="40">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @performance = @portfolio.analytics.period_performance(period: period)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="42">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    respond_to do |format|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="43">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      format.json { render json: @performance }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="49">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="50">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">    @portfolio = Portfolio.find(params[:portfolio_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def authorize_user!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="54">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">    unless @portfolio.user == current_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="55">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      redirect_to portfolios_path, alert: &quot;You are not authorized to view this portfolio&#39;s analytics.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a57d1d63f7fc5712b9617f8213a3a7ec85fae928">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4>
      <span class="red">
  71.43%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>7</b> relevant lines.
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Only allow modern browsers supporting webp images, web push, badges, import maps, CSS nesting, and CSS :has.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  allow_browser versions: :modern</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Configure permitted parameters for Devise</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :configure_permitted_parameters, if: :devise_controller?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  protected</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def configure_permitted_parameters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    devise_parameter_sanitizer.permit(:sign_up, keys: [ :first_name, :last_name ])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    devise_parameter_sanitizer.permit(:account_update, keys: [ :first_name, :last_name ])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5e7da4fd8c010e14061d52fb16a6b327f60a3292">
  <div class="header">
    <h3>app/controllers/home_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>7</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class HomeController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    if user_signed_in?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">      @portfolio_count = current_user.portfolios.count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="92d3b46c6bc72f09b2610c2c4b94a9e42d96fd89">
  <div class="header">
    <h3>app/controllers/portfolios_controller.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>46</b> relevant lines.
      <span class="green"><b>46</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PortfoliosController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authenticate_user!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :set_portfolio, only: [ :show, :edit, :update, :destroy, :ai_advisor ]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authorize_user!, only: [ :show, :edit, :update, :destroy, :ai_advisor ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="7">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    @portfolios = current_user.portfolios.order(created_at: :desc)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    # @portfolio is set by before_action</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    # Ensure exchange rates are up to date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="13">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    ensure_fresh_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="17">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    @portfolio = current_user.portfolios.build</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="21">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    @portfolio = current_user.portfolios.build(portfolio_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="23">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    if @portfolio.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="24">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      redirect_to @portfolio, notice: &quot;Portfolio was successfully created.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="26">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      render :new, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def edit</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    # @portfolio is set by before_action</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="35">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    if @portfolio.update(portfolio_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="36">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      redirect_to @portfolio, notice: &quot;Portfolio was successfully updated.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="38">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      render :edit, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="43">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @portfolio.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="44">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    redirect_to portfolios_url, notice: &quot;Portfolio was successfully deleted.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def ai_advisor</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="48">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    advisor = AI::PortfolioAdvisor.new(@portfolio)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="49">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    result = advisor.generate_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="51">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="52">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        analysis: result[:analysis],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        generated_at: result[:generated_at]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="58">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">        error: result[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="67">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="68">
            
              <span class="hits">30</span>
            

            

            <code class="ruby">    @portfolio = Portfolio.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def authorize_user!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="72">
            
              <span class="hits">30</span>
            

            

            <code class="ruby">    unless @portfolio.user == current_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="73">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      redirect_to portfolios_path, alert: &quot;You are not authorized to perform this action.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="77">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def portfolio_params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="78">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">    params.require(:portfolio).permit(:name, :description)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">  # Ensure exchange rates are updated if they&#39;re stale (older than 1 day)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="82">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def ensure_fresh_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    forex_pairs = [</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="84">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      { from: &#39;USD&#39;, to: &#39;TRY&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">      { from: &#39;EUR&#39;, to: &#39;TRY&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="88">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    forex_service = MarketData::ForexDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="90">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    forex_pairs.each do |pair|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">      # Check if we have a rate from today</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="92">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">      latest_rate = CurrencyRate.where(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">        from_currency: pair[:from],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">        to_currency: pair[:to]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">      ).order(date: :desc).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">      # If no rate exists or the latest rate is older than today, fetch a new one</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="98">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">      if latest_rate.nil? || latest_rate.date &lt; Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="100">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">          forex_service.update_currency_rate(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">            from_currency: pair[:from],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">            to_currency: pair[:to]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="104">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">          Rails.logger.info &quot;Updated #{pair[:from]}/#{pair[:to]} exchange rate&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="106">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to update #{pair[:from]}/#{pair[:to]}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cef55fd7d1ae1de7512eb7d76eb279067a548d7d">
  <div class="header">
    <h3>app/controllers/positions_controller.rb</h3>
    <h4>
      <span class="green">
  94.87%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>78</b> relevant lines.
      <span class="green"><b>74</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PositionsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authenticate_user!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :set_portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authorize_portfolio!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :set_position, only: [:show, :edit, :update, :destroy, :progress]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    @positions = @portfolio.positions.includes(:asset)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    @transactions = @position.transactions.order(date: :desc)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="16">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @position = @portfolio.positions.build</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="17">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @assets = Asset.all.order(:name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="21">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    @position = @portfolio.positions.build(position_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="23">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    if @position.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="24">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      redirect_to portfolio_path(@portfolio), notice: &quot;Position was successfully created.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="26">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      @assets = Asset.all.order(:name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="27">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      render :new, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def edit</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="32">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    @assets = Asset.all.order(:name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="35">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="36">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    if @position.update(position_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="37">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      redirect_to portfolio_path(@portfolio), notice: &quot;Position was successfully updated.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="39">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      @assets = Asset.all.order(:name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="40">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      render :edit, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="45">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @position.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="46">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    redirect_to portfolio_path(@portfolio), notice: &quot;Position was successfully deleted.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="49">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def progress</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    # Fetch historical price data for the position</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="51">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @price_data = calculate_progress_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="53">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    respond_to do |format|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="54">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      format.html { render :progress, layout: false }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="55">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      format.json { render json: @price_data }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def price_for_date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="60">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    asset = Asset.find(params[:asset_id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="61">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    date = Date.parse(params[:date])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    # Try to find price history for the exact date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="64">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    price_history = asset.price_histories.find_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="66">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    if price_history</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="67">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">        price: price_history.close.round(4),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">        currency: asset.currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">        date: date.strftime(&#39;%Y-%m-%d&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="72">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # If not found, try to fetch historical data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="76">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    days_back = (Date.today - date).to_i + 5</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="77">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    MarketData::HistoricalPriceFetcher.fetch_for_asset(asset, days: days_back)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    # Try again after fetching</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="80">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    price_history = asset.price_histories.find_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="82">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    if price_history</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">        price: price_history.close.round(4),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        currency: asset.currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">        date: date.strftime(&#39;%Y-%m-%d&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">      # Try to find the closest date (within 7 days)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="90">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      closest = asset.price_histories</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">        .where(&#39;date &gt;= ? AND date &lt;= ?&#39;, date - 7.days, date + 7.days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">        .order(Arel.sql(&quot;ABS(date - DATE &#39;#{date.strftime(&#39;%Y-%m-%d&#39;)}&#39;)&quot;))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">        .first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="95">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      if closest</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="96">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">          price: closest.close.round(4),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">          currency: asset.currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">          date: closest.date.strftime(&#39;%Y-%m-%d&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">          note: &quot;Price from #{closest.date.strftime(&#39;%Y-%m-%d&#39;)} (closest available)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="103">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">          error: &quot;No price data available for #{date.strftime(&#39;%Y-%m-%d&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">        }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">  rescue Date::Error</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="109">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    render json: { error: &quot;Invalid date format&quot; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="111">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    render json: { error: &quot;Asset not found&quot; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="114">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="116">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def calculate_progress_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">    # Get price history from purchase date to today</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="118">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    start_date = @position.purchase_date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="119">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    end_date = Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    # Fetch price histories for the asset</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="122">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    price_histories = @position.asset.price_histories</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">      .where(date: start_date..end_date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      .order(:date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">    # If we don&#39;t have enough historical data, try to fetch it</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="127">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    if price_histories.count &lt; 2</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      MarketData::HistoricalPriceFetcher.fetch_for_asset(@position.asset, days: (end_date - start_date).to_i + 30)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">      price_histories = @position.asset.price_histories</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">        .where(date: start_date..end_date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">        .order(:date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">    # Calculate position value for each date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="135">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    data_points = price_histories.map do |ph|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">      # Calculate position value at this date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="137">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      value_in_asset_currency = @position.quantity * ph.close</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">      # Convert to portfolio base currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="140">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      value_in_base_currency = if @position.asset.currency == @portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="141">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        value_in_asset_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">        CurrencyConverterService.convert_to_base_currency(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">          amount: value_in_asset_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">          from_currency: @position.asset.currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">          to_currency: @portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">        ) || value_in_asset_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">      # Calculate cost basis in base currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="151">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      cost_basis = @position.total_cost</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">      # Calculate profit/loss</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="154">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      profit_loss = value_in_base_currency - cost_basis</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="155">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      profit_loss_pct = cost_basis &gt; 0 ? ((profit_loss / cost_basis) * 100).round(2) : 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="158">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        date: ph.date.strftime(&#39;%Y-%m-%d&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">        value: value_in_base_currency.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">        cost_basis: cost_basis.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">        profit_loss: profit_loss.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">        profit_loss_percentage: profit_loss_pct,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">        price: ph.close.round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="168">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      position: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">        asset_symbol: @position.asset.symbol,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">        asset_name: @position.asset.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">        quantity: @position.quantity,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">        purchase_date: @position.purchase_date.strftime(&#39;%Y-%m-%d&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">        purchase_currency: @position.purchase_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">        average_cost: @position.average_cost,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">        current_value: @position.current_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">        total_cost: @position.total_cost.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">        profit_loss: @position.profit_loss.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">        profit_loss_percentage: @position.profit_loss_percentage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">      currency: @portfolio.base_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">      data_points: data_points</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="185">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="39" data-linenumber="186">
            
              <span class="hits">39</span>
            

            

            <code class="ruby">    @portfolio = Portfolio.find(params[:portfolio_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="189">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def authorize_portfolio!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="39" data-linenumber="190">
            
              <span class="hits">39</span>
            

            

            <code class="ruby">    unless @portfolio.user == current_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="191">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      redirect_to portfolios_path, alert: &quot;You are not authorized to perform this action.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="195">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_position</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="196">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">    @position = @portfolio.positions.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="199">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def position_params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="200">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">    params.require(:position).permit(:asset_id, :purchase_date, :quantity, :average_cost, :purchase_currency, :notes, :status)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a9957d6673b1bf7e2d5f707091a5574175c36944">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module ApplicationHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dfdb5f16330e3a905e796ffa16f4e09bcba61ce6">
  <div class="header">
    <h3>app/helpers/home_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module HomeHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d31566f0cb11380775b3bec3233df9f30abe6555">
  <div class="header">
    <h3>app/helpers/portfolios_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module PortfoliosHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="99abfa6f5af7e9de28e958d658a37ff5ead52692">
  <div class="header">
    <h3>app/helpers/positions_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module PositionsHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a08053d2e1a3efe7b771758d0c6ae1ae1775e240">
  <div class="header">
    <h3>app/jobs/application_job.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationJob &lt; ActiveJob::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Automatically retry jobs that encountered a deadlock</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # retry_on ActiveRecord::Deadlocked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Most jobs are safe to ignore if the underlying records are no longer available</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # discard_on ActiveJob::DeserializationError</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e4f5c53ba44ce997e29bd38a5d928bae28bc5193">
  <div class="header">
    <h3>app/jobs/fetch_commodity_prices_job.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Background job to fetch and update precious metal prices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Runs every 30 minutes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class FetchCommodityPricesJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Retry logic for transient API errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  retry_on MarketData::TwelveDataProvider::ApiError, wait: 5.minutes, attempts: 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def perform</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="10">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting FetchCommodityPricesJob&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="12">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    service = MarketData::CommodityDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="13">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    result = service.batch_update_prices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="15">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;FetchCommodityPricesJob completed: #{result[:success]} successful, #{result[:failed]} failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Log any errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="18">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    if result[:errors].any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="19">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error &quot;FetchCommodityPricesJob errors: #{result[:errors].join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="22">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    result</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="24">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error &quot;FetchCommodityPricesJob failed with error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="26">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ff43b390fcaa70fff7700c41d8fc29dbec13197b">
  <div class="header">
    <h3>app/jobs/fetch_cryptocurrency_prices_job.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Background job to fetch and update cryptocurrency prices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Runs every 30 minutes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class FetchCryptocurrencyPricesJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Retry logic for transient API errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  retry_on MarketData::TwelveDataProvider::ApiError, wait: 5.minutes, attempts: 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def perform</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="10">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting FetchCryptocurrencyPricesJob&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="12">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    service = MarketData::CryptocurrencyDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="13">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    result = service.batch_update_prices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="15">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;FetchCryptocurrencyPricesJob completed: #{result[:success]} successful, #{result[:failed]} failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Log any errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="18">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    if result[:errors].any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="19">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error &quot;FetchCryptocurrencyPricesJob errors: #{result[:errors].join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="22">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    result</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="24">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error &quot;FetchCryptocurrencyPricesJob failed with error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="26">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2ac042e83360d3851cbbab5a2a75c1749770369d">
  <div class="header">
    <h3>app/jobs/fetch_forex_rates_job.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Background job to fetch and update forex exchange rates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Runs every 15 minutes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class FetchForexRatesJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Retry logic for transient API errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  retry_on MarketData::TwelveDataProvider::ApiError, wait: 5.minutes, attempts: 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def perform</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="10">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting FetchForexRatesJob&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="12">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    service = MarketData::ForexDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="13">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    result = service.batch_update_turkish_rates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="15">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;FetchForexRatesJob completed: #{result[:success]} successful, #{result[:failed]} failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Log any errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="18">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    if result[:errors].any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="19">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error &quot;FetchForexRatesJob errors: #{result[:errors].join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="22">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    result</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="24">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error &quot;FetchForexRatesJob failed with error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="26">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5c5417d64fc54559f4ec24304163a1046394b4ad">
  <div class="header">
    <h3>app/jobs/fetch_stock_prices_job.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Background job to fetch and update stock and ETF prices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Runs daily at 6 PM (after BIST closes) on weekdays</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class FetchStockPricesJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Retry logic for transient API errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  retry_on MarketData::TwelveDataProvider::ApiError, wait: 5.minutes, attempts: 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def perform(exchange: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="10">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting FetchStockPricesJob for exchange: #{exchange || &#39;all&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="12">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    service = MarketData::StockDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="13">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    result = service.batch_update_prices(exchange: exchange)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="15">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    Rails.logger.info &quot;FetchStockPricesJob completed: #{result[:success]} successful, #{result[:failed]} failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Log any errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="18">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    if result[:errors].any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="19">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error &quot;FetchStockPricesJob errors: #{result[:errors].join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="22">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    result</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="24">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error &quot;FetchStockPricesJob failed with error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="26">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e6c98df4e18aff2379d3bf6ebf5840f6bc214575">
  <div class="header">
    <h3>app/mailers/application_mailer.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class ApplicationMailer &lt; ActionMailer::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  default from: &quot;from@example.com&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  layout &quot;mailer&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="966f3aafb8afd6a52ed82c40e630fddb65153f50">
  <div class="header">
    <h3>app/models/application_record.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationRecord &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  primary_abstract_class</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="706cb74519658fc9f53c3ade03ca2a2ab5b73c33">
  <div class="header">
    <h3>app/models/asset.rb</h3>
    <h4>
      <span class="green">
  96.67%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>30</b> relevant lines.
      <span class="green"><b>29</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Asset &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :positions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :price_histories, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_one :asset_metadata, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :symbol, presence: true, uniqueness: { scope: :exchange }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :asset_class, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :currency, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # Asset classes with enum</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  enum :asset_class, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    stock: 0,           # Turkish stocks (BIST) or international</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    precious_metal: 1,  # Gold, Silver, Platinum, Palladium</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    forex: 2,           # Currency pairs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    cryptocurrency: 3,  # Bitcoin, Ethereum, etc.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    etf: 4,            # Exchange-Traded Funds</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    bond: 5            # Fixed income</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  # Exchange/source information</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  enum :exchange, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    bist: 0,           # Borsa Istanbul</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    twelve_data: 1,    # Twelve Data commodities/forex</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    binance: 2,        # Crypto exchange</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    nyse: 3,           # New York Stock Exchange</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    nasdaq: 4          # NASDAQ</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  # Get the latest price</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def latest_price</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="825" data-linenumber="32">
            
              <span class="hits">825</span>
            

            

            <code class="ruby">    price_histories.order(date: :desc).first&amp;.close</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  # Check if price data is stale (older than 24 hours)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="36">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def stale_price?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="37">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    return true if latest_price.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="38">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    price_histories.order(date: :desc).first.date &lt; 1.day.ago</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  # Format symbol for Twelve Data API based on asset class</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def twelve_data_symbol</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="43">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">    case asset_class.to_sym</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    when :stock</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">      # US stocks don&#39;t need exchange suffix, Turkish stocks do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="46">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">      if exchange.to_sym == :bist</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="47">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">        &quot;#{symbol}:#{exchange.upcase}&quot;  # e.g., &quot;THYAO:BIST&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="49">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        symbol  # e.g., &quot;AAPL&quot; for NASDAQ/NYSE</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    when :etf</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="52">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      symbol  # e.g., &quot;SPY&quot; - ETFs use plain symbol</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    when :precious_metal</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="54">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      &quot;#{symbol}/USD&quot;                  # e.g., &quot;XAU/USD&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">    when :forex</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="56">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      symbol                           # e.g., &quot;USD/TRY&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    when :cryptocurrency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="58">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      &quot;#{symbol}/USD&quot;                  # e.g., &quot;BTC/USD&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      symbol</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">  # Human-readable asset class name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def asset_class_display</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="66">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    case asset_class.to_sym</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    when :precious_metal</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="68">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      &quot;Precious Metal&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    when :cryptocurrency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="70">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      &quot;Cryptocurrency&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="72">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      asset_class.titleize</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c94e338b1a7a3df2a925c0d68d4bf20cfe21a071">
  <div class="header">
    <h3>app/models/asset_metadata.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>3</b> relevant lines.
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AssetMetadata &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :asset</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :metadata, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Example metadata structures:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # Precious metals: { purity: &quot;99.99%&quot;, unit: &quot;troy_oz&quot;, metal_type: &quot;gold&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # Stocks: { sector: &quot;Technology&quot;, market_cap: 1000000000, employees: 5000 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Crypto: { blockchain: &quot;Ethereum&quot;, max_supply: 21000000 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6b44db94f6d1256ee3080d71f88821be6bfe9080">
  <div class="header">
    <h3>app/models/currency_rate.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>12</b> relevant lines.
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class CurrencyRate &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :from_currency, :to_currency, :rate, :date, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :rate, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :from_currency, uniqueness: { scope: [:to_currency, :date] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Get the latest rate between two currencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.latest_rate(from, to)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="8">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    return 1.0 if from == to</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="10">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    rate = where(from_currency: from, to_currency: to)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">           .order(date: :desc)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">           .first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="14">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    rate&amp;.rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  # Get rate for a specific date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.rate_on_date(from, to, date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="19">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    return 1.0 if from == to</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="21">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    rate = where(from_currency: from, to_currency: to, date: date).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="22">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    rate&amp;.rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e5dd615a25177a491d375173b74f470020ac07b7">
  <div class="header">
    <h3>app/models/portfolio.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>12</b> relevant lines.
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Portfolio &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :positions, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :assets, through: :positions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :user, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Calculate total portfolio value in base currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # Note: Will be enhanced in Phase 4 with proper currency conversion</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="12">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">    positions.sum(&amp;:current_value)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  # Get base currency (default to TRY for now, will add column in future)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1350" data-linenumber="17">
            
              <span class="hits">1350</span>
            

            

            <code class="ruby">    &#39;TRY&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  # Get analytics service for this portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def analytics</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="22">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">    @analytics ||= PortfolioAnalyticsService.new(self)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fa4b1270baef3184b9df86efb6ffba99bedf0679">
  <div class="header">
    <h3>app/models/position.rb</h3>
    <h4>
      <span class="red">
  79.66%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>59</b> relevant lines.
      <span class="green"><b>47</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Position &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :asset</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :transactions, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :quantity, presence: true, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :average_cost, presence: true, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :purchase_date, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :purchase_currency, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  enum :status, { open: 0, closed: 1 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # Fetch latest price for the asset after creating a position</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  after_create :fetch_asset_price, if: :should_fetch_price?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def should_fetch_price?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    # Only fetch if the asset doesn&#39;t have a recent price (within last 24 hours)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="196" data-linenumber="20">
            
              <span class="hits">196</span>
            

            

            <code class="ruby">    !asset.price_histories.where(&#39;date &gt;= ?&#39;, 1.day.ago).exists?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def fetch_asset_price</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="24">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    case asset.asset_class.to_sym</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    when :precious_metal</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      MarketData::CommodityDataService.new.update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    when :stock, :etf</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      # ETFs use the same price fetching as stocks</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      MarketData::StockDataService.new.update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    when :forex</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      # Forex pairs already have their rates stored in CurrencyRate table</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">      # We&#39;ll create a price history from the latest forex rate</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      fetch_forex_price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    when :cryptocurrency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      # Cryptocurrencies use the same API endpoint as forex pairs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="36">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      fetch_crypto_price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    when :bond</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      # Bonds are not supported by Twelve Data free tier</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      Rails.logger.warn &quot;Bond price fetching not supported for #{asset.symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  rescue MarketData::TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    Rails.logger.warn &quot;Could not fetch price for #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to fetch price for asset #{asset.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def fetch_forex_price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">    # Forex pairs are stored in format &quot;USD/TRY&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    # We use ForexDataService to fetch and store in CurrencyRate table</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    # Then create a PriceHistory record from it</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    parts = asset.symbol.split(&#39;/&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    return nil unless parts.length == 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    forex_service = MarketData::ForexDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    rate_record = forex_service.update_currency_rate(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      from_currency: parts[0],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      to_currency: parts[1]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    if rate_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      # Create price history from the rate</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      price_history = asset.price_histories.find_or_initialize_by(date: rate_record.date)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">        open: rate_record.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">        high: rate_record.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">        low: rate_record.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">        close: rate_record.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">        volume: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">        currency: parts[1]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      price_history.save ? price_history : nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="76">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def fetch_crypto_price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">    # Use the dedicated cryptocurrency service</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="78">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    MarketData::CryptocurrencyDataService.new.update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="81">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  public</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  # Calculate current value in asset&#39;s currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="84">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def current_value_in_asset_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="407" data-linenumber="85">
            
              <span class="hits">407</span>
            

            

            <code class="ruby">    return 0 if asset.latest_price.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="405" data-linenumber="86">
            
              <span class="hits">405</span>
            

            

            <code class="ruby">    quantity * asset.latest_price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">  # Calculate current value in portfolio&#39;s base currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">  # Uses CurrencyConverterService for multi-currency support</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="91">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def current_value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="405" data-linenumber="92">
            
              <span class="hits">405</span>
            

            

            <code class="ruby">    value_in_asset_currency = current_value_in_asset_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="405" data-linenumber="93">
            
              <span class="hits">405</span>
            

            

            <code class="ruby">    return 0 if value_in_asset_currency.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">    # Convert from asset&#39;s currency to portfolio&#39;s base currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="404" data-linenumber="96">
            
              <span class="hits">404</span>
            

            

            <code class="ruby">    if asset.currency == portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="97">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      value_in_asset_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="379" data-linenumber="99">
            
              <span class="hits">379</span>
            

            

            <code class="ruby">      ::CurrencyConverterService.convert_to_base_currency(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">        amount: value_in_asset_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">        from_currency: asset.currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">        to_currency: portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">  # Calculate total cost basis in purchase currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="108">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_cost_in_purchase_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="259" data-linenumber="109">
            
              <span class="hits">259</span>
            

            

            <code class="ruby">    quantity * average_cost</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  # Calculate total cost basis in portfolio&#39;s base currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="113">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_cost</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="258" data-linenumber="114">
            
              <span class="hits">258</span>
            

            

            <code class="ruby">    cost_in_purchase_currency = total_cost_in_purchase_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">    # If currencies match, return cost directly</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="258" data-linenumber="117">
            
              <span class="hits">258</span>
            

            

            <code class="ruby">    if purchase_currency == portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="56" data-linenumber="118">
            
              <span class="hits">56</span>
            

            

            <code class="ruby">      cost_in_purchase_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">      # Convert from purchase currency to portfolio base currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="202" data-linenumber="121">
            
              <span class="hits">202</span>
            

            

            <code class="ruby">      ::CurrencyConverterService.convert_to_base_currency(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">        amount: cost_in_purchase_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">        from_currency: purchase_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">        to_currency: portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">  # Calculate profit/loss (both in portfolio&#39;s base currency)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="130">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def profit_loss</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="98" data-linenumber="131">
            
              <span class="hits">98</span>
            

            

            <code class="ruby">    current_value - total_cost</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">  # Calculate profit/loss percentage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="135">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def profit_loss_percentage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="136">
            
              <span class="hits">45</span>
            

            

            <code class="ruby">    return 0 if total_cost.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="137">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">    ((profit_loss / total_cost) * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">  # Weight in portfolio (percentage)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="141">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def portfolio_weight</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="142">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">    portfolio_total = portfolio.total_value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="143">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">    return 0 if portfolio_total.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="144">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">    ((current_value / portfolio_total) * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4707c18aa4ecfa7eb5047cdde2f2a47bdf9d76a5">
  <div class="header">
    <h3>app/models/price_history.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>9</b> relevant lines.
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PriceHistory &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :asset</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :date, presence: true, uniqueness: { scope: :asset_id }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :close, presence: true, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :currency, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :for_date_range, -&gt;(start_date, end_date) {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="9">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    where(date: start_date..end_date).order(date: :asc)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :recent, -&gt;(days = 30) {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="13">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    where(&#39;date &gt;= ?&#39;, days.days.ago).order(date: :desc)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ac3c20a9d0a2999de09e17e5b23d3c41f76ec425">
  <div class="header">
    <h3>app/models/transaction.rb</h3>
    <h4>
      <span class="red">
  40.91%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>22</b> relevant lines.
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Transaction &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :position</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :transaction_type, :date, :quantity, :price, :currency, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :quantity, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :price, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  enum :transaction_type, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    buy: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    sell: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    dividend: 2,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    stock_split: 3,        # Stock splits</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    conversion: 4    # Currency conversions for forex</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # After creating transaction, update position&#39;s average cost</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  after_create :update_position_average_cost</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update_position_average_cost</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    return unless buy? || sell?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    position.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    transactions = position.transactions.where(transaction_type: [:buy, :sell]).order(date: :asc)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    total_quantity = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    total_cost = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    transactions.each do |txn|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      if txn.buy?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        total_quantity += txn.quantity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        total_cost += (txn.quantity * txn.price)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      elsif txn.sell?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">        total_quantity -= txn.quantity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    position.update(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      quantity: total_quantity,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      average_cost: total_quantity &gt; 0 ? total_cost / total_quantity : 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3c65de0677001c47e985d0ee0979ae160f39cd6c">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>6</b> relevant lines.
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class User &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Include default devise modules. Others available are:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # :confirmable, :lockable, :timeoutable, :trackable and :omniauthable</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  devise :database_authenticatable, :registerable,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">         :recoverable, :rememberable, :validatable</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # Associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :portfolios, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # Validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :email, presence: true, uniqueness: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # Optional: Method to get full name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def full_name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="15">
            
              <span class="hits">42</span>
            

            

            <code class="ruby">    &quot;#{first_name} #{last_name}&quot;.strip.presence || email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3383c7e460238085765a5f9ed375ef1e53543704">
  <div class="header">
    <h3>app/services/ai/portfolio_advisor.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>57</b> relevant lines.
      <span class="green"><b>57</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># AI-powered portfolio analysis and recommendation service</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module AI</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class PortfolioAdvisor</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize(portfolio)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="41" data-linenumber="5">
            
              <span class="hits">41</span>
            

            

            <code class="ruby">      @portfolio = portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="41" data-linenumber="6">
            
              <span class="hits">41</span>
            

            

            <code class="ruby">      @client = Anthropic::Client.new(api_key: ENV[&#39;ANTHROPIC_API_KEY&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def generate_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="10">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      return { error: &quot;API key not configured&quot; } unless ENV[&#39;ANTHROPIC_API_KEY&#39;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="12">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      portfolio_data = prepare_portfolio_data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="13">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      market_data = prepare_market_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="15">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      prompt = build_analysis_prompt(portfolio_data, market_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="18">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        response = @client.messages.create(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">          model: &quot;claude-3-haiku-20240307&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">          max_tokens: 2000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">          messages: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">              role: &quot;user&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">              content: prompt</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">          ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="30">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">          analysis: response.content.first[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">          generated_at: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="35">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.error &quot;AI Portfolio Advisor Error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="37">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">          error: &quot;Failed to generate recommendations: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def prepare_portfolio_data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="46">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      positions = @portfolio.positions.includes(:asset).map do |position|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="47">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        latest_price = position.asset.price_histories.order(date: :desc).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="48">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        current_value = latest_price ? position.quantity * latest_price.close : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="49">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        cost_basis = position.quantity * position.average_cost</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="50">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        gain_loss = current_value &amp;&amp; cost_basis ? current_value - cost_basis : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="51">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        gain_loss_pct = gain_loss &amp;&amp; cost_basis &gt; 0 ? (gain_loss / cost_basis * 100).round(2) : nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="54">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">          asset_name: position.asset.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">          asset_type: position.asset.asset_class,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">          symbol: position.asset.symbol,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">          quantity: position.quantity,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">          average_cost: position.average_cost,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">          currency: position.asset.currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">          purchase_date: position.purchase_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">          cost_basis: cost_basis.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">          current_value: current_value&amp;.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">          gain_loss: gain_loss&amp;.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">          gain_loss_percentage: gain_loss_pct,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="65">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">          days_held: (Date.today - position.purchase_date).to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="69">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      total_value = @portfolio.positions.sum do |position|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="70">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        latest_price = position.asset.price_histories.order(date: :desc).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="71">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        latest_price ? position.quantity * latest_price.close : 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="74">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">      total_cost = @portfolio.positions.sum { |p| p.quantity * p.average_cost }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="75">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      total_gain_loss = total_value - total_cost</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="76">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      total_gain_loss_pct = total_cost &gt; 0 ? (total_gain_loss / total_cost * 100).round(2) : 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="79">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">        name: @portfolio.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">        total_positions: positions.count,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        positions: positions,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">        total_value: total_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">        total_cost: total_cost.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">        total_gain_loss: total_gain_loss.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        total_gain_loss_percentage: total_gain_loss_pct,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">        currency: @portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="90">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def prepare_market_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">      # Get recent price trends for assets in portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="92">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      trends = @portfolio.positions.includes(:asset).map do |position|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="93">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">        asset = position.asset</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="94">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">        recent_prices = asset.price_histories.order(date: :desc).limit(30)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="96">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">        if recent_prices.count &gt;= 2</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="97">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">          latest = recent_prices.first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="98">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">          month_ago = recent_prices.last</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="99">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">          price_change = ((latest.close - month_ago.close) / month_ago.close * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="102">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">            symbol: asset.symbol,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">            asset_name: asset.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">            latest_price: latest.close.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">            price_change_30d: price_change,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="106">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">            trend: price_change &gt; 0 ? &quot;up&quot; : &quot;down&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="110">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            symbol: asset.symbol,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">            asset_name: asset.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">            note: &quot;Insufficient data for trend analysis&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="118">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        trends: trends,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">        analysis_date: Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="123">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def build_analysis_prompt(portfolio_data, market_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="124">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">        You are an expert financial advisor analyzing an investment portfolio. Please provide personalized recommendations based on the following data.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">        PORTFOLIO OVERVIEW:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">        Portfolio Name: #{portfolio_data[:name]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">        Base Currency: #{portfolio_data[:currency]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">        Total Positions: #{portfolio_data[:total_positions]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">        Total Value: #{portfolio_data[:total_value]} #{portfolio_data[:currency]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">        Total Cost Basis: #{portfolio_data[:total_cost]} #{portfolio_data[:currency]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">        Overall Gain/Loss: #{portfolio_data[:total_gain_loss]} #{portfolio_data[:currency]} (#{portfolio_data[:total_gain_loss_percentage]}%)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">        POSITIONS:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">        #{format_positions(portfolio_data[:positions])}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">        RECENT MARKET TRENDS (30-day):</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">        #{format_market_trends(market_data[:trends])}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">        Please provide:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">        1. **Portfolio Health Assessment**: Overall evaluation of the portfolio&#39;s performance and risk profile.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">        2. **Diversification Analysis**: Comment on asset allocation and diversification across asset types, sectors, and currencies.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">        3. **Position-Specific Insights**: Highlight any positions that deserve attention (strong performers, underperformers, high-risk holdings).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">        4. **Actionable Recommendations**: Provide 3-5 specific, actionable recommendations to improve the portfolio.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">        5. **Risk Factors**: Identify key risks and vulnerabilities in the current portfolio composition.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">        6. **Market Opportunities**: Based on recent trends, suggest potential areas for consideration.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">        Please format your response in clear sections with headers. Be specific, data-driven, and actionable. Keep the tone professional but accessible.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="159">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def format_positions(positions)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="160">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">      positions.map.with_index(1) do |pos, idx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="161">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">        status = if pos[:gain_loss_percentage]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="162">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">                   pos[:gain_loss_percentage] &gt; 0 ? &quot; +#{pos[:gain_loss_percentage]}%&quot; : &quot; #{pos[:gain_loss_percentage]}%&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">                 else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="164">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">                   &quot; No current value&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">                 end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">        &lt;&lt;~POSITION</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="168">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">          #{idx}. #{pos[:asset_name]} (#{pos[:symbol]}) - #{pos[:asset_type].upcase}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">             - Quantity: #{pos[:quantity]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">             - Avg Cost: #{pos[:average_cost]} #{pos[:currency]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">             - Cost Basis: #{pos[:cost_basis]} #{pos[:currency]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">             - Current Value: #{pos[:current_value] || &#39;N/A&#39;} #{pos[:currency]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">             - Gain/Loss: #{pos[:gain_loss] || &#39;N/A&#39;} #{pos[:currency]} #{status}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">             - Holding Period: #{pos[:days_held]} days</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">             - Purchase Date: #{pos[:purchase_date]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">        POSITION</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">      end.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="180">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def format_market_trends(trends)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="181">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">      trends.map do |trend|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="182">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">        if trend[:note]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="183">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          &quot;- #{trend[:asset_name]} (#{trend[:symbol]}): #{trend[:note]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="185">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          direction = trend[:price_change_30d] &gt; 0 ? &quot;&quot; : &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="186">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          &quot;- #{trend[:asset_name]} (#{trend[:symbol]}): #{direction} #{trend[:price_change_30d]}% over 30 days (Latest: #{trend[:latest_price]})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">      end.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="74d7c4e0a53282412c52b5fac62398eb0109fe23">
  <div class="header">
    <h3>app/services/currency_converter_service.rb</h3>
    <h4>
      <span class="green">
  91.67%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>48</b> relevant lines.
      <span class="green"><b>44</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Service for converting between currencies</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Uses cached rates from database when available, fetches from API when needed</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class CurrencyConverterService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="712" data-linenumber="5">
            
              <span class="hits">712</span>
            

            

            <code class="ruby">    @forex_service = MarketData::ForexDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # Convert amount from one currency to another</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # @param amount [Float] Amount to convert</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # @param from_currency [String] From currency code (e.g., &quot;USD&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # @param to_currency [String] To currency code (e.g., &quot;TRY&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  # @param date [Date] Date for historical conversion (default: today)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # @return [Float] Converted amount</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def convert(amount:, from_currency:, to_currency:, date: Date.today)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="624" data-linenumber="15">
            
              <span class="hits">624</span>
            

            

            <code class="ruby">    return amount if from_currency == to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="622" data-linenumber="16">
            
              <span class="hits">622</span>
            

            

            <code class="ruby">    return 0 if amount.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="621" data-linenumber="18">
            
              <span class="hits">621</span>
            

            

            <code class="ruby">    rate = get_rate(from_currency: from_currency, to_currency: to_currency, date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="621" data-linenumber="19">
            
              <span class="hits">621</span>
            

            

            <code class="ruby">    return nil unless rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="599" data-linenumber="21">
            
              <span class="hits">599</span>
            

            

            <code class="ruby">    amount * rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  # Get exchange rate between two currencies</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  # @param from_currency [String] From currency code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  # @param to_currency [String] To currency code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  # @param date [Date] Date for the rate (default: today)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  # @return [Float] Exchange rate</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def get_rate(from_currency:, to_currency:, date: Date.today)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="628" data-linenumber="30">
            
              <span class="hits">628</span>
            

            

            <code class="ruby">    return 1.0 if from_currency == to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    # Try direct rate first (FROM -&gt; TO)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="627" data-linenumber="33">
            
              <span class="hits">627</span>
            

            

            <code class="ruby">    rate = find_cached_rate(from_currency: from_currency, to_currency: to_currency, date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="627" data-linenumber="34">
            
              <span class="hits">627</span>
            

            

            <code class="ruby">    return rate if rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    # Try reverse rate (TO -&gt; FROM) and invert it</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="37">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">    reverse_rate = find_cached_rate(from_currency: to_currency, to_currency: from_currency, date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="38">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">    return 1.0 / reverse_rate if reverse_rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    # If not in cache and date is today, fetch from API</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="41">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">    if date == Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="42">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      fetch_and_cache_rate(from_currency: from_currency, to_currency: to_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="44">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">      Rails.logger.warn &quot;No rate found for #{from_currency}/#{to_currency} on #{date}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">  # Batch convert multiple amounts</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  # @param amounts [Array&lt;Hash&gt;] Array of {amount:, from:, to:} hashes</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  # @return [Array&lt;Float&gt;] Converted amounts</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def batch_convert(amounts)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="53">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    amounts.map do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="54">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      convert(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        amount: item[:amount],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">        from_currency: item[:from],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">        to_currency: item[:to],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">        date: item[:date] || Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  # Convert portfolio position value to base currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">  # @param position [Position] Position to convert</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">  # @param base_currency [String] Target currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">  # @return [Float] Value in base currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="67">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def convert_position_value(position, base_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">    # Get current value in position&#39;s purchase currency</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    value_in_purchase_currency = position.current_value_in_purchase_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    # Convert to base currency if different</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    if position.purchase_currency == base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      value_in_purchase_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">      convert(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">        amount: value_in_purchase_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">        from_currency: position.purchase_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">        to_currency: base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">      ) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  # Get all available rates for a date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">  # @param date [Date] Date to get rates for</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">  # @return [Hash] Hash of currency pairs to rates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="86">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def available_rates(date: Date.today)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="87">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    rates = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="89">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    CurrencyRate.where(date: date).find_each do |rate|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="90">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      key = &quot;#{rate.from_currency}/#{rate.to_currency}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="91">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      rates[key] = rate.rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="94">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    rates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">  # Update Position model to use this service for current_value calculation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">  # This will be called from Position#current_value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="99">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.convert_to_base_currency(amount:, from_currency:, to_currency:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="581" data-linenumber="100">
            
              <span class="hits">581</span>
            

            

            <code class="ruby">    return amount if from_currency == to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="580" data-linenumber="102">
            
              <span class="hits">580</span>
            

            

            <code class="ruby">    service = new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="580" data-linenumber="103">
            
              <span class="hits">580</span>
            

            

            <code class="ruby">    service.convert(amount: amount, from_currency: from_currency, to_currency: to_currency) || amount</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="106">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">  # Find cached rate in database</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">  # @param from_currency [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">  # @param to_currency [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">  # @param date [Date] Date for the rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  # @return [Float, nil] Rate if found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="113">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def find_cached_rate(from_currency:, to_currency:, date:)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">    # Look for exact date first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="656" data-linenumber="115">
            
              <span class="hits">656</span>
            

            

            <code class="ruby">    rate = CurrencyRate.find_by(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">      from_currency: from_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      to_currency: to_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">      date: date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="656" data-linenumber="121">
            
              <span class="hits">656</span>
            

            

            <code class="ruby">    return rate.rate if rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">    # If looking for today&#39;s rate, also check yesterday (markets might be closed)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="53" data-linenumber="124">
            
              <span class="hits">53</span>
            

            

            <code class="ruby">    if date == Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="125">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">      yesterday_rate = CurrencyRate.where(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">        from_currency: from_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">        to_currency: to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      ).where(&#39;date &gt;= ?&#39;, 1.day.ago).order(date: :desc).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="130">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">      return yesterday_rate.rate if yesterday_rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">  # Fetch rate from API and cache it</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">  # @param from_currency [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">  # @param to_currency [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">  # @return [Float, nil] Rate if successfully fetched</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="140">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def fetch_and_cache_rate(from_currency:, to_currency:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="141">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    rate_record = @forex_service.update_currency_rate(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">      from_currency: from_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">      to_currency: to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="146">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    rate_record&amp;.rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">  rescue MarketData::TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="148">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to fetch rate #{from_currency}/#{to_currency}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="149">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c76d34a6223f30fe80e50555ab64d782d94f8407">
  <div class="header">
    <h3>app/services/market_data/commodity_data_service.rb</h3>
    <h4>
      <span class="green">
  94.29%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>70</b> relevant lines.
      <span class="green"><b>66</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Service for fetching precious metals data from Twelve Data API</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Supports: Gold (XAU), Silver (XAG), Platinum (XPT), Palladium (XPD)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module MarketData</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class CommodityDataService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    PRECIOUS_METALS = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      &#39;XAU&#39; =&gt; { name: &#39;Gold&#39;, description: &#39;Gold spot price in USD per troy ounce&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">      &#39;XAG&#39; =&gt; { name: &#39;Silver&#39;, description: &#39;Silver spot price in USD per troy ounce&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">      &#39;XPT&#39; =&gt; { name: &#39;Platinum&#39;, description: &#39;Platinum spot price in USD per troy ounce&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">      &#39;XPD&#39; =&gt; { name: &#39;Palladium&#39;, description: &#39;Palladium spot price in USD per troy ounce&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    }.freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="13">
            
              <span class="hits">43</span>
            

            

            <code class="ruby">      @provider = TwelveDataProvider.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    # Fetch current quote for a precious metal</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    # @return [Hash] Quote data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def fetch_quote(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="20">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a precious metal&quot; unless asset.precious_metal?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="22">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      symbol = asset.twelve_data_symbol</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="23">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      @provider.quote(symbol)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    # Update price history for a precious metal</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data to fetch</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    # @return [Integer] Number of price records created/updated</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_price_history(asset, days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="31">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a precious metal&quot; unless asset.precious_metal?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="33">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      symbol = asset.twelve_data_symbol</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="34">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      data = @provider.time_series(symbol, interval: &#39;1day&#39;, outputsize: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="36">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      return 0 unless data &amp;&amp; data[&#39;values&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="38">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="40">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      data[&#39;values&#39;].each do |price_data|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="41">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        date = Date.parse(price_data[&#39;datetime&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="43">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        price_history = asset.price_histories.find_or_initialize_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="44">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">          open: price_data[&#39;open&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">          high: price_data[&#39;high&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">          low: price_data[&#39;low&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">          close: price_data[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">          volume: price_data[&#39;volume&#39;]&amp;.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">          currency: &#39;USD&#39; # Precious metals are priced in USD</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="53">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        if price_history.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="54">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to save price history for #{symbol} on #{date}: #{price_history.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="60">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    # Update latest price only (faster than full history)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    # @return [PriceHistory] The created/updated price record</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="66">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="67">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a precious metal&quot; unless asset.precious_metal?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="69">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      quote = fetch_quote(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="70">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      return nil unless quote &amp;&amp; quote[&#39;close&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="72">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      date = quote[&#39;datetime&#39;] ? Date.parse(quote[&#39;datetime&#39;]) : Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="74">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history = asset.price_histories.find_or_initialize_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="75">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">        open: quote[&#39;open&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">        high: quote[&#39;high&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">        low: quote[&#39;low&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">        close: quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">        volume: quote[&#39;volume&#39;]&amp;.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        currency: &#39;USD&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="84">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history.save ? price_history : nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    # Seed all precious metals</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    # @return [Integer] Number of metals created</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="89">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def seed_precious_metals</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="90">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="92">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      PRECIOUS_METALS.each do |symbol, data|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="93">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">        asset = Asset.find_or_initialize_by(symbol: symbol, exchange: :twelve_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="94">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">        asset.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">          name: data[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">          asset_class: :precious_metal,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">          currency: &#39;USD&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">          description: data[:description]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="101">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">        if asset.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">          # Create or update metadata with additional info</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="103">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">          metadata = asset.asset_metadata || asset.build_asset_metadata</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="104">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">          metadata.metadata = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">            unit: &#39;troy ounce&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">            base_currency: &#39;USD&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">            category: &#39;Precious Metal&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">            tradable: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="110">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">          metadata.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="112">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="113">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">          Rails.logger.info &quot;Created/updated precious metal: #{symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to create precious metal #{symbol}: #{asset.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="119">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">    # Batch update prices for all precious metals</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">    # @return [Hash] Summary of updates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="124">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def batch_update_prices</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="125">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      query = Asset.precious_metal</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="127">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      summary = { success: 0, failed: 0, errors: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="129">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      query.find_each do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="131">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">          update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="132">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="133">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          sleep(1) # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">        rescue TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="135">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="136">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          summary[:errors] &lt;&lt; { symbol: asset.symbol, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="137">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to update #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="141">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    # Convert precious metal price to TRY</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">    # Uses current USD/TRY rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">    # @param usd_price [Float] Price in USD</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">    # @param usd_try_rate [Float] Current USD/TRY exchange rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">    # @return [Float] Price in TRY</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="149">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def convert_to_try(usd_price, usd_try_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      usd_price * usd_try_rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">    # Get precious metal price in multiple currencies</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">    # @param currencies [Array&lt;String&gt;] Target currencies (default: [&#39;TRY&#39;, &#39;EUR&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">    # @return [Hash] Prices in different currencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="157">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def get_price_in_currencies(asset, currencies: [&#39;TRY&#39;, &#39;EUR&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="158">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a precious metal&quot; unless asset.precious_metal?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="160">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      latest_price = asset.latest_price</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="161">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      return {} unless latest_price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="163">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      prices = { &#39;USD&#39; =&gt; latest_price }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="165">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      currencies.each do |currency|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="166">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        next if currency == &#39;USD&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="169">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          rate_data = @provider.exchange_rate(from: &#39;USD&#39;, to: currency)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="170">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          if rate_data &amp;&amp; rate_data[&#39;rate&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="171">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            prices[currency] = latest_price * rate_data[&#39;rate&#39;].to_f</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="173">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          sleep(0.5) # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">        rescue TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to get USD/#{currency} rate: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="179">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      prices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c11c0c1a568350358d41fb69a8e615f3568f5545">
  <div class="header">
    <h3>app/services/market_data/cryptocurrency_data_service.rb</h3>
    <h4>
      <span class="green">
  95.59%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>68</b> relevant lines.
      <span class="green"><b>65</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Service for fetching cryptocurrency data from Twelve Data API</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Supports Bitcoin, Ethereum, and other major cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module MarketData</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class CryptocurrencyDataService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    POPULAR_CRYPTOCURRENCIES = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      &#39;BTC&#39; =&gt; { name: &#39;Bitcoin&#39;, description: &#39;Bitcoin - Digital currency&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">      &#39;ETH&#39; =&gt; { name: &#39;Ethereum&#39;, description: &#39;Ethereum - Smart contract platform&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">      &#39;BNB&#39; =&gt; { name: &#39;Binance Coin&#39;, description: &#39;Binance Coin - Exchange token&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">      &#39;XRP&#39; =&gt; { name: &#39;Ripple&#39;, description: &#39;XRP - Payment protocol&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      &#39;ADA&#39; =&gt; { name: &#39;Cardano&#39;, description: &#39;Cardano - Blockchain platform&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      &#39;DOGE&#39; =&gt; { name: &#39;Dogecoin&#39;, description: &#39;Dogecoin - Meme cryptocurrency&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      &#39;SOL&#39; =&gt; { name: &#39;Solana&#39;, description: &#39;Solana - High-performance blockchain&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      &#39;DOT&#39; =&gt; { name: &#39;Polkadot&#39;, description: &#39;Polkadot - Multi-chain protocol&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    }.freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="17">
            
              <span class="hits">43</span>
            

            

            <code class="ruby">      @provider = TwelveDataProvider.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # Fetch current quote for a cryptocurrency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # @return [Hash] Quote data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def fetch_quote(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="24">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a cryptocurrency&quot; unless asset.cryptocurrency?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="26">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      symbol = asset.twelve_data_symbol</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="27">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      @provider.quote(symbol)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    # Update price history for a cryptocurrency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data to fetch</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    # @return [Integer] Number of price records created/updated</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_price_history(asset, days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="35">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a cryptocurrency&quot; unless asset.cryptocurrency?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="37">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      symbol = asset.twelve_data_symbol</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="38">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      data = @provider.time_series(symbol, interval: &#39;1day&#39;, outputsize: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="40">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      return 0 unless data &amp;&amp; data[&#39;values&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="42">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="44">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      data[&#39;values&#39;].each do |price_data|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="45">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        date = Date.parse(price_data[&#39;datetime&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="47">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        price_history = asset.price_histories.find_or_initialize_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="48">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">          open: price_data[&#39;open&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">          high: price_data[&#39;high&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">          low: price_data[&#39;low&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">          close: price_data[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">          volume: price_data[&#39;volume&#39;]&amp;.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">          currency: asset.currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="57">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        if price_history.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="58">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to save price history for #{symbol} on #{date}: #{price_history.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="64">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    # Update latest price only (faster than full history)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    # @return [PriceHistory] The created/updated price record</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="70">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="71">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a cryptocurrency&quot; unless asset.cryptocurrency?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="73">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      quote = fetch_quote(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="74">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      return nil unless quote &amp;&amp; quote[&#39;close&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="76">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      date = quote[&#39;datetime&#39;] ? Date.parse(quote[&#39;datetime&#39;]) : Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="78">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history = asset.price_histories.find_or_initialize_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="79">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">        open: quote[&#39;open&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        high: quote[&#39;high&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">        low: quote[&#39;low&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">        close: quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">        volume: quote[&#39;volume&#39;]&amp;.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        currency: asset.currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="88">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history.save ? price_history : nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">    # Seed popular cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">    # @return [Integer] Number of cryptocurrencies created</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="93">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def seed_popular_cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="94">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="96">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      POPULAR_CRYPTOCURRENCIES.each do |symbol, data|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="97">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">        asset = Asset.find_or_initialize_by(symbol: symbol, exchange: :twelve_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="98">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">        asset.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">          name: data[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">          asset_class: :cryptocurrency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">          currency: &#39;USD&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">          description: data[:description]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="105">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">        if asset.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">          # Create or update metadata</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="107">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">          metadata = asset.asset_metadata || asset.build_asset_metadata</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="108">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">          metadata.metadata = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">            category: &#39;Cryptocurrency&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">            tradable: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">            base_currency: &#39;USD&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="113">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">          metadata.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="115">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="116">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">          Rails.logger.info &quot;Created/updated cryptocurrency: #{symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to create cryptocurrency #{symbol}: #{asset.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="122">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">    # Batch update prices for all cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">    # @return [Hash] Summary of updates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="127">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def batch_update_prices</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="128">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      query = Asset.cryptocurrency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="130">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      summary = { success: 0, failed: 0, errors: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="132">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      query.find_each do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="134">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">          update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="135">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="136">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          sleep(1) # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">        rescue TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="138">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="139">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          summary[:errors] &lt;&lt; { symbol: asset.symbol, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="140">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to update #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="144">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">    # Get cryptocurrency price in multiple currencies</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">    # @param currencies [Array&lt;String&gt;] Target currencies (default: [&#39;TRY&#39;, &#39;EUR&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">    # @return [Hash] Prices in different currencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="151">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def get_price_in_currencies(asset, currencies: [&#39;TRY&#39;, &#39;EUR&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="152">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a cryptocurrency&quot; unless asset.cryptocurrency?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="154">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      latest_price = asset.latest_price</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="155">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      return {} unless latest_price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="157">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      prices = { &#39;USD&#39; =&gt; latest_price }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="159">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      currencies.each do |currency|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="160">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        next if currency == &#39;USD&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="163">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          rate_data = @provider.exchange_rate(from: &#39;USD&#39;, to: currency)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="164">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          if rate_data &amp;&amp; rate_data[&#39;rate&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="165">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            prices[currency] = latest_price * rate_data[&#39;rate&#39;].to_f</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="167">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          sleep(0.5) # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">        rescue TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to get USD/#{currency} rate: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="173">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      prices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="73dd444c1dde7e7a2a64a40ba541947120f6c901">
  <div class="header">
    <h3>app/services/market_data/forex_data_service.rb</h3>
    <h4>
      <span class="green">
  98.53%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>68</b> relevant lines.
      <span class="green"><b>67</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Service for fetching forex (currency pair) data from Twelve Data API</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Supports all major currency pairs including Turkish Lira</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module MarketData</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class ForexDataService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Important Turkish Lira forex pairs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    TURKISH_FOREX_PAIRS = [</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      { from: &#39;USD&#39;, to: &#39;TRY&#39;, name: &#39;US Dollar / Turkish Lira&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">      { from: &#39;EUR&#39;, to: &#39;TRY&#39;, name: &#39;Euro / Turkish Lira&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">      { from: &#39;GBP&#39;, to: &#39;TRY&#39;, name: &#39;British Pound / Turkish Lira&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      { from: &#39;EUR&#39;, to: &#39;USD&#39;, name: &#39;Euro / US Dollar&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="756" data-linenumber="14">
            
              <span class="hits">756</span>
            

            

            <code class="ruby">      @provider = TwelveDataProvider.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Fetch current exchange rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    # @param from_currency [String] From currency (e.g., &quot;USD&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    # @param to_currency [String] To currency (e.g., &quot;TRY&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # @return [Hash] Exchange rate data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def fetch_exchange_rate(from_currency:, to_currency:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="22">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      @provider.exchange_rate(from: from_currency, to: to_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    # Fetch forex quote</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    # @param from_currency [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    # @param to_currency [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    # @return [Hash] Quote data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def fetch_quote(from_currency:, to_currency:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      symbol = &quot;#{from_currency}/#{to_currency}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      @provider.quote(symbol)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # Update currency rate in database</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    # @param from_currency [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    # @param to_currency [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    # @param date [Date] Date for the rate (default: today)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    # @return [CurrencyRate] The created/updated rate record</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_currency_rate(from_currency:, to_currency:, date: Date.today)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="40">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      rate_data = fetch_exchange_rate(from_currency: from_currency, to_currency: to_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="42">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      return nil unless rate_data &amp;&amp; rate_data[&#39;rate&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="44">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      currency_rate = CurrencyRate.find_or_initialize_by(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        from_currency: from_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        to_currency: to_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">        date: date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="50">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      currency_rate.rate = rate_data[&#39;rate&#39;].to_f</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      # Explicitly update the timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="52">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      currency_rate.updated_at = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="54">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      if currency_rate.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="55">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        Rails.logger.info &quot;Updated rate: #{from_currency}/#{to_currency} = #{currency_rate.rate} on #{date}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="56">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        currency_rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="58">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.error &quot;Failed to save rate #{from_currency}/#{to_currency}: #{currency_rate.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    # Update historical rates for a currency pair</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    # @param from_currency [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    # @param to_currency [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    # @return [Integer] Number of rates created/updated</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="68">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_rate_history(from_currency:, to_currency:, days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="69">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      symbol = &quot;#{from_currency}/#{to_currency}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="70">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      data = @provider.time_series(symbol, interval: &#39;1day&#39;, outputsize: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="72">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      return 0 unless data &amp;&amp; data[&#39;values&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="74">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="76">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      data[&#39;values&#39;].each do |rate_data|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="77">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        date = Date.parse(rate_data[&#39;datetime&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="79">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        currency_rate = CurrencyRate.find_or_initialize_by(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">          from_currency: from_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">          to_currency: to_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">          date: date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="85">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        currency_rate.rate = rate_data[&#39;close&#39;].to_f</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="87">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        if currency_rate.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="88">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="90">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to save rate for #{date}: #{currency_rate.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="94">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">    # Seed Turkish forex pairs as assets</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    # @return [Integer] Number of forex assets created</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="99">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def seed_turkish_forex_pairs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="100">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="102">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      TURKISH_FOREX_PAIRS.each do |pair|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="103">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">        symbol = &quot;#{pair[:from]}/#{pair[:to]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="105">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">        asset = Asset.find_or_initialize_by(symbol: symbol, exchange: :twelve_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="106">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">        asset.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">          name: pair[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">          asset_class: :forex,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">          currency: pair[:to], # Quote currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">          description: &quot;Exchange rate from #{pair[:from]} to #{pair[:to]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="113">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">        if asset.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">          # Create or update metadata</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="115">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          metadata = asset.asset_metadata || asset.build_asset_metadata</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="116">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          metadata.metadata = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">            base_currency: pair[:from],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">            quote_currency: pair[:to],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">            category: &#39;Forex&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">            tradable: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="122">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          metadata.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="124">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="125">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          Rails.logger.info &quot;Created/updated forex pair: #{symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to create forex pair #{symbol}: #{asset.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="131">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">    # Batch update all important Turkish forex rates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">    # @return [Hash] Summary of updates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="136">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def batch_update_turkish_rates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="137">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      summary = { success: 0, failed: 0, errors: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="139">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      TURKISH_FOREX_PAIRS.each do |pair|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="141">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">          update_currency_rate(from_currency: pair[:from], to_currency: pair[:to])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="142">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="143">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          sleep(1) # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">        rescue TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="145">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="146">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          summary[:errors] &lt;&lt; { pair: &quot;#{pair[:from]}/#{pair[:to]}&quot;, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="147">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to update #{pair[:from]}/#{pair[:to]}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="151">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">    # Get current rate (from cache or API)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">    # @param from_currency [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">    # @param to_currency [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">    # @param max_age_hours [Integer] Maximum age of cached rate in hours</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">    # @return [Float] Exchange rate</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="159">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def get_current_rate(from_currency:, to_currency:, max_age_hours: 24)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">      # Try to get from database first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="161">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      cached_rate = CurrencyRate.where(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">        from_currency: from_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">        to_currency: to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">      ).where(&#39;date &gt;= ?&#39;, max_age_hours.hours.ago).order(date: :desc).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="166">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      if cached_rate</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="167">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        return cached_rate.rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">      # Fetch from API if cache miss</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="171">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      rate_record = update_currency_rate(from_currency: from_currency, to_currency: to_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="172">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      rate_record&amp;.rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">    # Convert amount from one currency to another</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">    # @param amount [Float] Amount to convert</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">    # @param from_currency [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">    # @param to_currency [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">    # @return [Float] Converted amount</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="180">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def convert(amount:, from_currency:, to_currency:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="181">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      return amount if from_currency == to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="183">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      rate = get_current_rate(from_currency: from_currency, to_currency: to_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="184">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      return nil unless rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="186">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      amount * rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="da851b6f70becc5538165251003d3c5f01b1f5e6">
  <div class="header">
    <h3>app/services/market_data/historical_price_fetcher.rb</h3>
    <h4>
      <span class="yellow">
  90.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>90</b> relevant lines.
      <span class="green"><b>81</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Unified service for fetching historical prices for any asset type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Automatically routes to the appropriate service based on asset class</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module MarketData</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class HistoricalPriceFetcher</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Fetch historical prices for a single asset</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    # @param asset [Asset] Asset to fetch prices for</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data (default: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    # @return [Integer] Number of price records created/updated</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def self.fetch_for_asset(asset, days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="10">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">      case asset.asset_class.to_sym</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      when :stock, :etf</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="12">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">        StockDataService.new.update_price_history(asset, days: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      when :precious_metal</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        CommodityDataService.new.update_price_history(asset, days: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      when :forex</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="16">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        parts = asset.symbol.split(&#39;/&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="17">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        count = ForexDataService.new.update_rate_history(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">          from_currency: parts[0],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">          to_currency: parts[1],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">          days: days</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">        # Sync CurrencyRate data to Asset price_histories</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="24">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        sync_forex_to_price_history(asset, parts[0], parts[1])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="25">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      when :cryptocurrency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        CryptocurrencyDataService.new.update_price_history(asset, days: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      when :bond</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.warn &quot;Historical prices not available for bonds: #{asset.symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        Rails.logger.error &quot;Unknown asset class: #{asset.asset_class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    rescue TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="36">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Rails.logger.error &quot;API error fetching history for #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to fetch history for #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    # Fetch historical prices for all assets in a portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    # @param portfolio [Portfolio] Portfolio whose assets to fetch</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data (default: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    # @return [Hash] Summary with success/failed counts</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def self.fetch_for_portfolio(portfolio, days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="48">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      summary = { success: 0, failed: 0, total: 0, errors: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">      # Get unique assets from portfolio positions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="51">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      assets = portfolio.assets.distinct</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="52">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      summary[:total] = assets.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="54">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      assets.each do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="56">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">          count = fetch_for_asset(asset, days: days)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="57">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          if count &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="58">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">            summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="59">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">            Rails.logger.info &quot;Fetched #{count} historical prices for #{asset.symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="61">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="62">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            summary[:errors] &lt;&lt; { symbol: asset.symbol, error: &quot;No data returned&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">          # Rate limiting: sleep 1 second between API calls</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="66">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          sleep(1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="68">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="69">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          summary[:errors] &lt;&lt; { symbol: asset.symbol, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="70">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          Rails.logger.error &quot;Error fetching history for #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="74">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">    # Fetch historical prices for all assets of a specific type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    # @param asset_class [Symbol] Asset class (:stock, :precious_metal, etc.)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data (default: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    # @return [Hash] Summary with success/failed counts</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="81">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def self.fetch_for_asset_class(asset_class, days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="82">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      summary = { success: 0, failed: 0, total: 0, errors: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="84">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      assets = Asset.where(asset_class: asset_class)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="85">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      summary[:total] = assets.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="87">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      assets.each do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="89">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          count = fetch_for_asset(asset, days: days)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="90">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          if count &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="91">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">            summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="92">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">            Rails.logger.info &quot;Fetched #{count} historical prices for #{asset.symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">            summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">            summary[:errors] &lt;&lt; { symbol: asset.symbol, error: &quot;No data returned&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">          # Rate limiting: sleep 1 second between API calls</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="99">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          sleep(1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">          summary[:errors] &lt;&lt; { symbol: asset.symbol, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">          Rails.logger.error &quot;Error fetching history for #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="107">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">    # Fetch historical prices for all assets in the database</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">    # WARNING: This can consume a lot of API credits!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data (default: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">    # @param exclude_bonds [Boolean] Skip bonds (default: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">    # @return [Hash] Summary with success/failed counts by asset class</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="115">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def self.fetch_all(days: 30, exclude_bonds: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">      overall_summary = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="117">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        total: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">        success: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">        failed: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">        by_asset_class: {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="123">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      asset_classes = Asset.asset_classes.keys.map(&amp;:to_sym)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="124">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      asset_classes -= [:bond] if exclude_bonds</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="126">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      asset_classes.each do |asset_class|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="127">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        Rails.logger.info &quot;Fetching historical prices for #{asset_class.to_s.pluralize}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="128">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        summary = fetch_for_asset_class(asset_class, days: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="130">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        overall_summary[:by_asset_class][asset_class] = summary</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="131">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        overall_summary[:total] += summary[:total]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="132">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        overall_summary[:success] += summary[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="133">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        overall_summary[:failed] += summary[:failed]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="136">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      overall_summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">    # Check which assets are missing historical data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">    # @param min_days [Integer] Minimum number of days of history expected (default: 7)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">    # @return [Array&lt;Asset&gt;] Assets with insufficient historical data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="142">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def self.find_assets_missing_history(min_days: 7)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="143">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      Asset.all.select do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="144">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">        asset.price_histories.count &lt; min_days</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">    # Fill missing historical data for assets</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">    # @param min_days [Integer] Minimum number of days expected (default: 7)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">    # @param fetch_days [Integer] Number of days to fetch (default: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">    # @return [Hash] Summary of updates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="152">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def self.fill_missing_history(min_days: 7, fetch_days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="153">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      missing_assets = find_assets_missing_history(min_days: min_days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">      summary = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="156">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        total: missing_assets.count,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">        success: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">        failed: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">        errors: []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="162">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      missing_assets.each do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="164">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          count = fetch_for_asset(asset, days: fetch_days)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="165">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          if count &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="166">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="167">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            Rails.logger.info &quot;Filled history for #{asset.symbol}: #{count} records&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">            summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">            summary[:errors] &lt;&lt; { symbol: asset.symbol, error: &quot;No data returned&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">          # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="174">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          sleep(1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="176">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="177">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          summary[:errors] &lt;&lt; { symbol: asset.symbol, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="181">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="184">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">    # Sync forex rates from CurrencyRate table to Asset price_histories</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="187">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def self.sync_forex_to_price_history(asset, from_currency, to_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="188">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      currency_rates = CurrencyRate.where(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">        from_currency: from_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">        to_currency: to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">      ).order(:date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="193">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="194">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      currency_rates.each do |rate|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="195">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">        price_history = asset.price_histories.find_or_initialize_by(date: rate.date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="196">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">        price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">          open: rate.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">          high: rate.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">          low: rate.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby">          close: rate.rate,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">          volume: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">          currency: to_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="204">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">        created_count += 1 if price_history.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="207">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      Rails.logger.info &quot;Synced #{created_count} forex rates to price history for #{asset.symbol}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="208">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b504616f36c884517c3f02e38639b7ad15781aac">
  <div class="header">
    <h3>app/services/market_data/stock_data_service.rb</h3>
    <h4>
      <span class="green">
  96.43%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>56</b> relevant lines.
      <span class="green"><b>54</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Service for fetching stock data from Twelve Data API</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Supports Turkish stocks (BIST) and international stocks</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module MarketData</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class StockDataService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="6">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      @provider = TwelveDataProvider.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    # Fetch current quote for a stock or ETF</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    # @return [Hash] Quote data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def fetch_quote(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="13">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a stock or ETF&quot; unless asset.stock? || asset.etf?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="15">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      symbol = asset.twelve_data_symbol</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="16">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      @provider.quote(symbol)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    # Update price history for a stock or ETF</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    # @param days [Integer] Number of days of historical data to fetch</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # @return [Integer] Number of price records created/updated</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_price_history(asset, days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="24">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a stock or ETF&quot; unless asset.stock? || asset.etf?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="26">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      symbol = asset.twelve_data_symbol</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="27">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      data = @provider.time_series(symbol, interval: &#39;1day&#39;, outputsize: days)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="29">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      return 0 unless data &amp;&amp; data[&#39;values&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="31">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="33">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      data[&#39;values&#39;].each do |price_data|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="34">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        date = Date.parse(price_data[&#39;datetime&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="36">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        price_history = asset.price_histories.find_or_initialize_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="37">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">          open: price_data[&#39;open&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">          high: price_data[&#39;high&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">          low: price_data[&#39;low&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">          close: price_data[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">          volume: price_data[&#39;volume&#39;].to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">          currency: asset.currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="46">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        if price_history.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="47">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to save price history for #{symbol} on #{date}: #{price_history.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="53">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    # Update latest price only (faster than full history)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    # @param asset [Asset] Asset record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">    # @return [PriceHistory] The created/updated price record</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="60">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Asset must be a stock or ETF&quot; unless asset.stock? || asset.etf?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="62">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      quote = fetch_quote(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="63">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      return nil unless quote &amp;&amp; quote[&#39;close&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="65">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      date = quote[&#39;datetime&#39;] ? Date.parse(quote[&#39;datetime&#39;]) : Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="67">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history = asset.price_histories.find_or_initialize_by(date: date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="68">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">        open: quote[&#39;open&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">        high: quote[&#39;high&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">        low: quote[&#39;low&#39;]&amp;.to_f || quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">        close: quote[&#39;close&#39;].to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">        volume: quote[&#39;volume&#39;]&amp;.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">        currency: asset.currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="77">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      price_history.save ? price_history : nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    # Seed Turkish stocks from BIST</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    # @return [Integer] Number of stocks created</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="82">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def seed_turkish_stocks</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">      turkish_stocks = [</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="84">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">        { symbol: &#39;THYAO&#39;, name: &#39;Trk Hava Yollar&#39;, sector: &#39;Transportation&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        { symbol: &#39;ASELS&#39;, name: &#39;Aselsan Elektronik&#39;, sector: &#39;Defense&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">        { symbol: &#39;AKBNK&#39;, name: &#39;Akbank&#39;, sector: &#39;Banking&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">        { symbol: &#39;EREGL&#39;, name: &#39;Ereli Demir elik&#39;, sector: &#39;Steel&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        { symbol: &#39;TUPRS&#39;, name: &#39;Tpra&#39;, sector: &#39;Oil &amp; Gas&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">        { symbol: &#39;SAHOL&#39;, name: &#39;Sabanc Holding&#39;, sector: &#39;Conglomerate&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">        { symbol: &#39;KOZAL&#39;, name: &#39;Koza Altn&#39;, sector: &#39;Mining&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">        { symbol: &#39;SISE&#39;, name: &#39;ie Cam&#39;, sector: &#39;Glass&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">        { symbol: &#39;GARAN&#39;, name: &#39;Garanti Bankas&#39;, sector: &#39;Banking&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">        { symbol: &#39;ISCTR&#39;, name: &#39; Bankas&#39;, sector: &#39;Banking&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="96">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      created_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="98">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      turkish_stocks.each do |stock_data|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="99">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">        asset = Asset.find_or_initialize_by(symbol: stock_data[:symbol], exchange: :bist)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="100">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">        asset.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">          name: stock_data[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">          asset_class: :stock,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">          currency: &#39;TRY&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="106">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">        if asset.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">          # Create or update metadata</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="108">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">          metadata = asset.asset_metadata || asset.build_asset_metadata</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="109">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">          metadata.metadata = { sector: stock_data[:sector] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="110">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">          metadata.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="112">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">          created_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="113">
            
              <span class="hits">50</span>
            

            

            <code class="ruby">          Rails.logger.info &quot;Created/updated stock: #{stock_data[:symbol]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to create stock #{stock_data[:symbol]}: #{asset.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="119">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      created_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">    # Batch update prices for all stocks</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">    # @param exchange [Symbol] Exchange to update (default: all)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">    # @return [Hash] Summary of updates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="125">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def batch_update_prices(exchange: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="126">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      query = Asset.stock</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="127">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      query = query.where(exchange: exchange) if exchange</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="129">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      summary = { success: 0, failed: 0, errors: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="131">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      query.find_each do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="133">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">          update_latest_price(asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="134">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">          summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="135">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">          sleep(1) # Rate limiting: ~60 calls/minute for free tier</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">        rescue TwelveDataProvider::ApiError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="137">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="138">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          summary[:errors] &lt;&lt; { symbol: asset.symbol, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="139">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to update #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="143">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4e6e425e5a93e2295638e73e4498090439430bca">
  <div class="header">
    <h3>app/services/market_data/twelve_data_provider.rb</h3>
    <h4>
      <span class="green">
  98.08%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>52</b> relevant lines.
      <span class="green"><b>51</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Service for interacting with Twelve Data API</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># Supports stocks, precious metals, forex, and cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module MarketData</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class TwelveDataProvider</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    include HTTParty</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    base_uri &#39;https://api.twelvedata.com&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="741" data-linenumber="9">
            
              <span class="hits">741</span>
            

            

            <code class="ruby">      @api_key = Rails.application.config.twelve_data[:api_key]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="741" data-linenumber="10">
            
              <span class="hits">741</span>
            

            

            <code class="ruby">      raise &quot;TWELVE_DATA_API_KEY not configured&quot; if @api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    # Get real-time quote for a symbol</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # @param symbol [String] Symbol to fetch (e.g., &quot;THYAO.BIST&quot;, &quot;XAU/USD&quot;, &quot;USD/TRY&quot;, &quot;BTC/USD&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # @return [Hash] Quote data with price, change, volume, etc.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def quote(symbol)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="17">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/quote&#39;, query: default_params.merge(symbol: symbol))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="18">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    # Get time series data (historical prices)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # @param symbol [String] Symbol to fetch</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    # @param interval [String] Time interval (1min, 5min, 15min, 30min, 45min, 1h, 2h, 4h, 8h, 1day, 1week, 1month)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    # @param outputsize [Integer] Number of data points to return (default: 30, max: 5000)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    # @return [Hash] Time series data with OHLCV values</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def time_series(symbol, interval: &#39;1day&#39;, outputsize: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="27">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/time_series&#39;, query: default_params.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">        symbol: symbol,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">        interval: interval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">        outputsize: outputsize</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      ))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="32">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    # Get earliest available date for a symbol</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    # @param symbol [String] Symbol to check</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    # @return [Hash] Information about the symbol&#39;s earliest date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def earliest_timestamp(symbol)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/earliest_timestamp&#39;, query: default_params.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">        symbol: symbol,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">        interval: &#39;1day&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      ))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    # Get end of day (EOD) price</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    # @param symbol [String] Symbol to fetch</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    # @return [Hash] EOD price data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="49">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def eod(symbol)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/eod&#39;, query: default_params.merge(symbol: symbol))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    # Convert currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">    # @param from [String] From currency (e.g., &quot;USD&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    # @param to [String] To currency (e.g., &quot;TRY&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    # @param amount [Float] Amount to convert (default: 1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">    # @return [Hash] Conversion result</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def currency_conversion(from:, to:, amount: 1)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="60">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/currency_conversion&#39;, query: default_params.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        symbol: &quot;#{from}/#{to}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">        amount: amount</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      ))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="64">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    # Get exchange rate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">    # @param from [String] From currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    # @param to [String] To currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">    # @return [Hash] Exchange rate data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def exchange_rate(from:, to:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="72">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/exchange_rate&#39;, query: default_params.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">        symbol: &quot;#{from}/#{to}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      ))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="75">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    # Get list of available commodities</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    # @return [Hash] List of commodities</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="80">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def commodities</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="81">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/commodities&#39;, query: default_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="82">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">    # Get list of available forex pairs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">    # @return [Hash] List of forex pairs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="87">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def forex_pairs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="88">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/forex_pairs&#39;, query: default_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="89">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">    # Get list of available cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">    # @return [Hash] List of cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="94">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def cryptocurrencies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="95">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/cryptocurrencies&#39;, query: default_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="96">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">    # Get list of stocks</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">    # @param exchange [String] Exchange code (e.g., &quot;BIST&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">    # @return [Hash] List of stocks</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="102">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def stocks(exchange: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="103">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      params = default_params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="104">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      params[:exchange] = exchange if exchange.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="105">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      response = self.class.get(&#39;/stocks&#39;, query: params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="106">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="109">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="111">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def default_params</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="113">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">        apikey: @api_key,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">        format: &#39;JSON&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="118">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def handle_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="119">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">      if response.success?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="120">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        parsed = response.parsed_response</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">        # Check for API error in response body</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="123">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        if parsed.is_a?(Hash) &amp;&amp; parsed[&#39;status&#39;] == &#39;error&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="124">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          raise ApiError, parsed[&#39;message&#39;] || &#39;Unknown API error&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="127">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        parsed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="129">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        error_message = response.parsed_response.is_a?(Hash) ?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">                       response.parsed_response[&#39;message&#39;] :</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">                       response.message</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="132">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise ApiError, &quot;HTTP #{response.code}: #{error_message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">    rescue JSON::ParserError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">      raise ApiError, &quot;Invalid JSON response: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="138">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class ApiError &lt; StandardError; end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="48bde42efec994e1fcf027978bdcc7b5bf4dc90d">
  <div class="header">
    <h3>app/services/portfolio_analytics_service.rb</h3>
    <h4>
      <span class="green">
  97.83%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>92</b> relevant lines.
      <span class="green"><b>90</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Service for calculating portfolio analytics and metrics</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PortfolioAnalyticsService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  attr_reader :portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def initialize(portfolio)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="6">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">    @portfolio = portfolio</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Calculate total portfolio value in base currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="122" data-linenumber="11">
            
              <span class="hits">122</span>
            

            

            <code class="ruby">    portfolio.positions.open.sum(&amp;:current_value)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  # Calculate total cost basis</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_cost</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="16">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">    portfolio.positions.open.sum(&amp;:total_cost)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  # Calculate total profit/loss</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_profit_loss</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="21">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">    total_value - total_cost</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  # Calculate total profit/loss percentage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="25">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_return_percentage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="26">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    return 0 if total_cost.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="27">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    ((total_profit_loss / total_cost) * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  # Get asset allocation by asset class</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  # Returns hash like: { stock: 45.5, etf: 20.0, precious_metal: 15.0, ... }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def asset_allocation_by_class</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="33">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">    return {} if total_value.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="35">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">    allocation = {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="36">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">    portfolio.positions.open.includes(:asset).group_by { |p| p.asset.asset_class }.each do |asset_class, positions|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="37">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">      class_value = positions.sum(&amp;:current_value)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="38">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">      percentage = ((class_value / total_value) * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="39">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">      allocation[asset_class.to_sym] = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">        value: class_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">        percentage: percentage,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">        count: positions.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="46">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">    allocation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">  # Get asset allocation by currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def asset_allocation_by_currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="51">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    return {} if total_value.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="53">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    allocation = {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="54">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">    portfolio.positions.open.includes(:asset).group_by { |p| p.asset.currency }.each do |currency, positions|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="55">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      currency_value = positions.sum(&amp;:current_value)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="56">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      percentage = ((currency_value / total_value) * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="57">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      allocation[currency.to_sym] = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">        value: currency_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        percentage: percentage,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">        count: positions.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="64">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    allocation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">  # Get top performing positions (by profit/loss percentage)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="68">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def top_performers(limit: 5)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="69">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    portfolio.positions.open</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">      .includes(:asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="71">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      .select { |p| p.profit_loss &gt; 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="72">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      .sort_by { |p| -p.profit_loss_percentage }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">      .first(limit)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="74">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      .map { |p| position_summary(p) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">  # Get worst performing positions (by profit/loss percentage)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="78">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def worst_performers(limit: 5)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="79">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    portfolio.positions.open</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">      .includes(:asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="81">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      .select { |p| p.profit_loss &lt; 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="82">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      .sort_by { |p| p.profit_loss_percentage }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">      .first(limit)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="84">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      .map { |p| position_summary(p) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">  # Get largest positions by value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="88">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def largest_positions(limit: 5)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="89">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    portfolio.positions.open</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">      .includes(:asset)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="91">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      .sort_by { |p| -p.current_value }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">      .first(limit)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="93">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      .map { |p| position_summary(p) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">  # Calculate portfolio diversity score (0-100)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">  # Higher score = more diversified</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="98">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def diversity_score</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="99">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    allocation = asset_allocation_by_class</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="100">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    return 0 if allocation.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">    # Use Herfindahl-Hirschman Index (HHI) inverted</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">    # HHI ranges from 0 to 10000 (all in one asset)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">    # We convert to 0-100 scale where 100 = perfectly diversified</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="105">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">    hhi = allocation.values.sum { |v| v[:percentage]**2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="106">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    max_hhi = 10000 # All in one asset</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="107">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    min_hhi = 10000 / allocation.count # Perfectly distributed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">    # Normalize to 0-100 scale</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="110">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    if hhi &gt;= max_hhi</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="111">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="113">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      score = ((max_hhi - hhi) / (max_hhi - min_hhi) * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="114">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      [score, 100].min # Cap at 100</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">  # Get portfolio value history over time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">  # Returns array of { date:, value: } for the last N days</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="120">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def value_timeline(days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="121">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    end_date = Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="122">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    start_date = end_date - days.days</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="124">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    timeline = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="125">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    (start_date..end_date).each do |date|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="70" data-linenumber="126">
            
              <span class="hits">70</span>
            

            

            <code class="ruby">      value = calculate_portfolio_value_at_date(date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="70" data-linenumber="127">
            
              <span class="hits">70</span>
            

            

            <code class="ruby">      timeline &lt;&lt; { date: date, value: value.round(2) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="130">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    timeline</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">  # Get performance metrics for a specific period</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="134">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def period_performance(period: :month)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="135">
            
              <span class="hits">35</span>
            

            

            <code class="ruby">    start_date = case period.to_sym</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="136">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    when :week then 1.week.ago.to_date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="137">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    when :month then 1.month.ago.to_date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="138">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    when :quarter then 3.months.ago.to_date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="139">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    when :year then 1.year.ago.to_date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="140">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    when :ytd then Date.today.beginning_of_year</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    else Date.today</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="144">
            
              <span class="hits">35</span>
            

            

            <code class="ruby">    current_value = total_value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="145">
            
              <span class="hits">35</span>
            

            

            <code class="ruby">    past_value = calculate_portfolio_value_at_date(start_date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="147">
            
              <span class="hits">35</span>
            

            

            <code class="ruby">    return { period: period, change: 0, change_percentage: 0 } if past_value.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="149">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    change = current_value - past_value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="150">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    change_percentage = ((change / past_value) * 100).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="153">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      period: period,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">      start_date: start_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">      end_date: Date.today,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      start_value: past_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      end_value: current_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">      change: change.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">      change_percentage: change_percentage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">  # Get complete analytics summary</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="164">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def analytics_summary</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="166">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      overview: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">        total_value: total_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">        total_cost: total_cost.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">        total_profit_loss: total_profit_loss.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">        total_return_percentage: total_return_percentage,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">        base_currency: portfolio.base_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">        position_count: portfolio.positions.open.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">      allocation: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">        by_asset_class: asset_allocation_by_class,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">        by_currency: asset_allocation_by_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">      performance: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">        top_performers: top_performers(limit: 5),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">        worst_performers: worst_performers(limit: 5),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">        largest_positions: largest_positions(limit: 5)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">      metrics: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">        diversity_score: diversity_score</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">      periods: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">        week: period_performance(period: :week),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">        month: period_performance(period: :month),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">        quarter: period_performance(period: :quarter),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">        year: period_performance(period: :year),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">        ytd: period_performance(period: :ytd)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="196">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">  # Calculate portfolio value at a specific historical date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="199">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def calculate_portfolio_value_at_date(date)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="105" data-linenumber="200">
            
              <span class="hits">105</span>
            

            

            <code class="ruby">    converter = CurrencyConverterService.new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="105" data-linenumber="201">
            
              <span class="hits">105</span>
            

            

            <code class="ruby">    total = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="105" data-linenumber="203">
            
              <span class="hits">105</span>
            

            

            <code class="ruby">    portfolio.positions.open.includes(:asset).each do |position|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">      # Get asset price at that date</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="105" data-linenumber="205">
            
              <span class="hits">105</span>
            

            

            <code class="ruby">      price_history = position.asset.price_histories.where(&#39;date &lt;= ?&#39;, date).order(date: :desc).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="105" data-linenumber="206">
            
              <span class="hits">105</span>
            

            

            <code class="ruby">      next unless price_history</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby">      # Calculate value in asset&#39;s currency</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="209">
            
              <span class="hits">29</span>
            

            

            <code class="ruby">      value_in_asset_currency = position.quantity * price_history.close</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            

            <code class="ruby">      # Convert to portfolio base currency using historical rate</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="212">
            
              <span class="hits">29</span>
            

            

            <code class="ruby">      if position.asset.currency == portfolio.base_currency</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">        total += value_in_asset_currency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="215">
            
              <span class="hits">29</span>
            

            

            <code class="ruby">        converted = converter.convert(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            

            <code class="ruby">          amount: value_in_asset_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            

            <code class="ruby">          from_currency: position.asset.currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">          to_currency: portfolio.base_currency,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby">          date: date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="221">
            
              <span class="hits">29</span>
            

            

            <code class="ruby">        total += converted if converted</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="105" data-linenumber="225">
            
              <span class="hits">105</span>
            

            

            <code class="ruby">    total</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">  # Create a summary hash for a position</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="229">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def position_summary(position)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="231">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      id: position.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">      asset_symbol: position.asset.symbol,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">      asset_name: position.asset.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            

            <code class="ruby">      asset_class: position.asset.asset_class,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">      quantity: position.quantity,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            

            <code class="ruby">      current_value: position.current_value.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">      total_cost: position.total_cost.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            

            <code class="ruby">      profit_loss: position.profit_loss.round(2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby">      profit_loss_percentage: position.profit_loss_percentage,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby">      portfolio_weight: position.portfolio_weight</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="241">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="565d69b092e23f60632bcf4e8d5a7aae71253edf">
  <div class="header">
    <h3>app/workers/market_data_update_worker.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>73</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>73</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Worker for updating market data (exchange rates and asset prices)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">class MarketDataUpdateWorker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  include Sidekiq::Worker</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  sidekiq_options retry: 3, queue: :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def perform(update_type = &#39;exchange_rates&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    case update_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    when &#39;exchange_rates&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      update_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    when &#39;position_prices&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      update_position_prices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    when &#39;all&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      update_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      update_position_prices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      Rails.logger.error &quot;Unknown update type: #{update_type}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  def update_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting exchange rate update...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    forex_pairs = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      { from: &#39;USD&#39;, to: &#39;TRY&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      { from: &#39;EUR&#39;, to: &#39;TRY&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      { from: &#39;EUR&#39;, to: &#39;USD&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      { from: &#39;GBP&#39;, to: &#39;USD&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      { from: &#39;USD&#39;, to: &#39;JPY&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    service = MarketData::ForexDataService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    summary = { total: forex_pairs.count, success: 0, failed: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    forex_pairs.each do |pair|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        count = service.update_rate_history(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">          from_currency: pair[:from],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">          to_currency: pair[:to],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">          days: 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">        if count &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">          summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          Rails.logger.info &quot;   #{pair[:from]}/#{pair[:to]}: #{count} rates updated&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">          Rails.logger.warn &quot;   #{pair[:from]}/#{pair[:to]}: No data returned&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        sleep(1) # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        Rails.logger.error &quot;   #{pair[:from]}/#{pair[:to]}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    Rails.logger.info &quot;Exchange rate update completed: #{summary[:success]}/#{summary[:total]} successful&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  def update_position_prices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting position price update...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    assets = Asset.joins(:positions).distinct</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    summary = { total: assets.count, success: 0, failed: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    assets.find_each do |asset|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">        result = MarketData::HistoricalPriceFetcher.fetch_for_asset(asset, days: 1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        if result &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">          summary[:success] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">          Rails.logger.info &quot;   #{asset.symbol}: Updated&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">          summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">          Rails.logger.warn &quot;   #{asset.symbol}: No data returned&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">        sleep(1) # Rate limiting</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        summary[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">        Rails.logger.error &quot;   #{asset.symbol}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    Rails.logger.info &quot;Position price update completed: #{summary[:success]}/#{summary[:total]} successful&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
